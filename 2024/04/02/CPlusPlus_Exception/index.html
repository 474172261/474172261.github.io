<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> C++ 异常处理的逆向 · VictorV的小博客</title><meta name="description" content="C++ 异常处理的逆向 - VictorV"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://474172261.github.io/atom.xml" title="VictorV的小博客"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="VictorV的小博客" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/vv474172261" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/474172261" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">C++ 异常处理的逆向</h1><div class="post-info">2024年4月2日</div><div class="post-content"><p>偶尔分析C++的模块, 遇到触发异常操作, 但是不知道它SEH到底干啥了, 所以研究了下MSVC下的c++异常处理到底是怎么回事, 没理解透彻, 但是逆向应该是够用了, 如果有不对之处, 还望指正.</p>
<span id="more"></span>

<h1 id="C-try-catch"><a href="#C-try-catch" class="headerlink" title="C++ try catch"></a>C++ try catch</h1><p>这是一段示例的测试代码:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(<span class="string">&quot;disable&quot;</span>:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ExceptionA</span> : <span class="keyword">public</span> exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">ExceptionA</span>(<span class="type">int</span> a, <span class="type">int</span> b) :<span class="built_in">a</span>(a), <span class="built_in">b</span>(b) &#123;&#125;</span><br><span class="line">    <span class="type">int</span> a, b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ExceptionB</span> : <span class="keyword">public</span> exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">ExceptionB</span>(<span class="type">int</span> a, <span class="type">int</span> b) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ExceptionC</span> : <span class="keyword">public</span> exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">ExceptionC</span>(<span class="type">int</span> a, <span class="type">int</span> b) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Strobj</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Strobj</span>() = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">Strobj</span>(<span class="type">char</span>* a) &#123;</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">strlen</span>(a);</span><br><span class="line">        str_ = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">strcpy_s</span>(str_, len+<span class="number">1</span>, a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span>* str_ = <span class="literal">NULL</span>;</span><br><span class="line">    ~<span class="built_in">Strobj</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (str_) &#123;</span><br><span class="line">            <span class="keyword">delete</span> str_;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Strobj <span class="title">doThrow</span><span class="params">(<span class="type">bool</span> doth)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>, b = <span class="number">2</span>;</span><br><span class="line">    <span class="type">char</span> str[] = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="function">Strobj <span class="title">oops</span><span class="params">(str)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (doth)</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExceptionA</span>(a, b);</span><br><span class="line">    <span class="keyword">return</span> oops;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        Strobj a = <span class="built_in">doThrow</span>(<span class="literal">true</span>);</span><br><span class="line">        std::cout &lt;&lt; a.str_ &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (ExceptionC&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ExceptionC caught&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (ExceptionB&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ExceptionB caught&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (ExceptionA&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ExceptionA caught&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (std::exception&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码很简单, 就是申请一个对象后触发异常.<br>正常情况下, 在触发异常后, 它会调用析构函数释放<code>str_</code>, 然后调用异常模块输出 “ExceptionA caught”.</p>
<p>这里简要介绍一下SEH, SEH就是异常捕获流程, 当程序发生异常的时候, 会跳转到最近(指最近的try catch)异常捕获函数, 它可以获取触发异常时的寄存器数据, 通过寄存器就知道触发异常时的原因, 如果能处理, 就修改异常时的rip值来跳转到后续的正常指令流, 如果不能处理就交给下一个SEH handler.</p>
<p>所以如果要知道触发异常后它怎么操作, 就看它注册的seh handler就行. 不过呢, msvc的C++ 对SEH做了封装, 异常由 <code>_CxxThrowException</code> 抛出. 处理会由<code>__GSHandlerCheck_EH4</code>进行简单操作后调用<code>__CxxFrameHandler4</code>进行处理</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>我们在调试器里对析构函数下断点, 触发断点后, 查看栈回溯, 得到如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">test.exe!`doThrow&#x27;::`1&#x27;::dtor$0()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de1030()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de4307()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de66ab()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de2cd2()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de2f5a()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de6dfb()</span><br><span class="line">test.exe!__GSHandlerCheck_EH4(_EXCEPTION_RECORD * ExceptionRecord=0x000000473ff0de60, void * EstablisherFrame=0x000000473ff0f9d0, _CONTEXT * ContextRecord=0x000000473ff0d760, _DISPATCHER_CONTEXT * DispatcherContext=0x000000473ff0dcd0) 行 73</span><br><span class="line">	在 D:\a\_work\1\s\src\vctools\crt\vcstartup\src\gs\amd64\gshandlereh4.cpp(73)</span><br><span class="line">ntdll.dll!00007ff9c5bb242f()</span><br><span class="line">ntdll.dll!00007ff9c5b40939()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de6a7f()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de1c1e()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de218b()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de2ec5()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de2f5a()</span><br><span class="line">vcruntime140_1d.dll!00007ff990de6dfb()</span><br><span class="line">test.exe!__GSHandlerCheck_EH4(_EXCEPTION_RECORD * ExceptionRecord=0x000000473ff0eff0, void * EstablisherFrame=0x000000473ff0fbc0, _CONTEXT * ContextRecord=0x000000473ff0eb00, _DISPATCHER_CONTEXT * DispatcherContext=0x000000473ff0e980) 行 73</span><br><span class="line">	在 D:\a\_work\1\s\src\vctools\crt\vcstartup\src\gs\amd64\gshandlereh4.cpp(73)</span><br><span class="line">ntdll.dll!00007ff9c5bb23af()</span><br><span class="line">ntdll.dll!00007ff9c5b614b4()</span><br><span class="line">ntdll.dll!00007ff9c5bb0ebe()</span><br><span class="line">KernelBase.dll!00007ff9c341cf19()</span><br><span class="line">vcruntime140d.dll!00007ff96105bbf1()</span><br><span class="line">test.exe!doThrow(bool doth=true) 行 45</span><br><span class="line">	在 D:\Projects\test\test\main.cpp(45)</span><br><span class="line">test.exe!main() 行 52</span><br><span class="line">	在 D:\Projects\test\test\main.cpp(52)</span><br></pre></td></tr></table></figure>
<p>可以看到, 它先调用的<code>__GSHandlerCheck_EH4</code>两次, 再调用了&#96;&#96;&#96;&#96;doThrow’::&#96;1’::dtor$0&#96;&#96;&#96;操作.</p>
<p>而且析构函数是先于catch模块调用的. C++没有<code>finally</code>关键词, 也是因为有析构函数, 就不需要finally了</p>
<h2 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(<span class="string">&quot;disable&quot;</span>:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ExceptionA</span> : <span class="keyword">public</span> exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">ExceptionA</span>(<span class="type">int</span> a, <span class="type">int</span> b) :<span class="built_in">a</span>(a), <span class="built_in">b</span>(b) &#123;&#125;</span><br><span class="line">    <span class="type">int</span> a, b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ExceptionB</span> : <span class="keyword">public</span> exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">ExceptionB</span>(<span class="type">int</span> a, <span class="type">int</span> b) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">ExceptionC</span> : <span class="keyword">public</span> exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">ExceptionC</span>(<span class="type">int</span> a, <span class="type">int</span> b) &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Strobj</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> index;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Strobj</span>() &#123;</span><br><span class="line">        index += <span class="number">1</span>;</span><br><span class="line">        <span class="type">char</span> a[] = <span class="string">&quot;abcdefghijklmnopq&quot;</span>;</span><br><span class="line">        <span class="type">char</span>* s = &amp;a[index];</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">strlen</span>(s);</span><br><span class="line">        str_ = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">strcpy_s</span>(str_, len + <span class="number">1</span>, s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Strobj</span>(<span class="type">char</span>* a) &#123;</span><br><span class="line">        <span class="type">int</span> len = <span class="built_in">strlen</span>(a);</span><br><span class="line">        str_ = <span class="keyword">new</span> <span class="type">char</span>[len + <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">strcpy_s</span>(str_, len+<span class="number">1</span>, a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span>* str_ = <span class="literal">NULL</span>;</span><br><span class="line">    ~<span class="built_in">Strobj</span>() &#123;</span><br><span class="line">        <span class="keyword">if</span> (str_) &#123;</span><br><span class="line">            <span class="keyword">delete</span> str_;</span><br><span class="line">            str_ = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> Strobj::index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Strobj <span class="title">doThrow</span><span class="params">(<span class="type">bool</span> doth)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>, b = <span class="number">2</span>;</span><br><span class="line">    <span class="type">char</span> str[] = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="function">Strobj <span class="title">oops</span><span class="params">(str)</span></span>;</span><br><span class="line">    <span class="function">Strobj <span class="title">oops2</span><span class="params">(&amp;str[<span class="number">1</span>])</span></span>;</span><br><span class="line">    <span class="function">Strobj <span class="title">oops3</span><span class="params">(&amp;str[<span class="number">2</span>])</span></span>;</span><br><span class="line">    Strobj* myObjectPtr = <span class="keyword">new</span> Strobj;</span><br><span class="line">    <span class="keyword">auto</span> myObjectPtr2 = std::<span class="built_in">make_unique</span>&lt;Strobj&gt;();</span><br><span class="line">    <span class="keyword">auto</span> myObjectPtr3 = std::<span class="built_in">make_shared</span>&lt;Strobj&gt;();</span><br><span class="line">    <span class="keyword">if</span> (doth)</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">ExceptionA</span>(a, b);</span><br><span class="line">    std::cout &lt;&lt; oops2.str_ &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; oops3.str_ &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; myObjectPtr-&gt;str_ &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; myObjectPtr2-&gt;str_ &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; myObjectPtr3-&gt;str_ &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> myObjectPtr;</span><br><span class="line">    <span class="keyword">return</span> oops;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        Strobj a = <span class="built_in">doThrow</span>(<span class="literal">true</span>);</span><br><span class="line">        std::cout &lt;&lt; a.str_ &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (ExceptionC&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ExceptionC caught&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (ExceptionB&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ExceptionB caught&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (ExceptionA&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ExceptionA caught&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (std::exception&amp; e)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ExceptionA1 caught&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ExceptionA2 caught&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这次新增了两个<code>Strobj</code>对象, 新增了, <code>release</code>编译后, 使用ida看看有什么不一样.</p>
<p>选择<code>doThrow</code>函数, 按’X’查看引用:</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712127361714.png" alt="1712127361714"></p>
<p>跟进<code>.pdata</code>的引用:</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712127336162.png" alt="1712127336162"></p>
<p>跟进 <code>stru_14002DFAC</code>:</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712127420884.png" alt="1712127420884"></p>
<p>可以看到多个析构函数. </p>
<h2 id="再次调试"><a href="#再次调试" class="headerlink" title="再次调试"></a>再次调试</h2><p>开启调试, 分别对所有偏移的函数下断点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">??1?$shared_ptr@VStrobj@@@std@@QEAA@XZ</span><br><span class="line">_doThrow____1___dtor$10</span><br><span class="line">??1?$unique_ptr@VStrobj@@U?$default_delete@VStrobj@@@std@@@std@@QEAA@XZ</span><br><span class="line">_doThrow____1___dtor$7</span><br><span class="line">_doThrow____1___dtor$3</span><br><span class="line">??1Strobj@@QEAA@XZ</span><br><span class="line">??1Strobj@@QEAA@XZ</span><br><span class="line">_doThrow____1___dtor$0</span><br></pre></td></tr></table></figure>

<p>继续运行, 看看触发情况:</p>
<p>第一个命中的是最后的一个shared_ptr的析构函数, 释放的是<code>myObjectPtr3</code></p>
<p><img src="/images/CPlusPlus_Exception.assets/1712127520943.png" alt="1712127520943"></p>
<p>第二个命中的是unique_ptr的析构函数, 释放的是<code>myObjectPtr2</code></p>
<p><img src="/images/CPlusPlus_Exception.assets/1712127599116.png" alt="1712127599116"></p>
<p>第三个命中的直接是Strobj的析构函数, 释放的是<code>oops3</code>,</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712127849317.png" alt="1712127849317"></p>
<p>第四个是<code>oops2</code></p>
<p>最后是<code>oops</code></p>
<p><img src="/images/CPlusPlus_Exception.assets/1712127884472.png" alt="1712127884472"></p>
<p>从断点命中情况来看, 它命中了<code>stru_14002DFAC</code>里的部分析构函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">??1?$shared_ptr@VStrobj@@@std@@QEAA@XZ</span><br><span class="line">??1?$unique_ptr@VStrobj@@U?$default_delete@VStrobj@@@std@@@std@@QEAA@XZ</span><br><span class="line">??1Strobj@@QEAA@XZ</span><br><span class="line">??1Strobj@@QEAA@XZ</span><br><span class="line">_doThrow____1___dtor$0</span><br></pre></td></tr></table></figure>

<p>但是, 这里有一个问题, <strong>那就是<code>myObjectPtr</code>并没有得到被的释放!!</strong></p>
<blockquote>
<p>我们用debug调试, 记录<code>myObjectPtr-&gt;str_</code>的地址, 当命中catch时, 查看该值, 发现没有被重置, 再次说明它并没有被释放</p>
</blockquote>
<p>因为它是new申请的, 需要我们手动释放, 而它又是个局部变量, 我们没法在catch里正常释放它, 导致它的内存丢失了.</p>
<p>再来看main.</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712128404597.png" alt="1712128404597"></p>
<p><img src="/images/CPlusPlus_Exception.assets/1712128467028.png" alt="1712128467028"></p>
<p>可以看到 main的<code>.pdata</code>里对应的<code>stru_14002E010</code>里, 有main的异常处理的代码块的<code>rva</code>.   这里因为有4个catch, 所以有4个异常处理块.</p>
<p>所以我们也可以发现, 在try catch操作中, 存在catch的函数, 它的stru指向里就有catch的操作模块, 也会给出异常的类型.</p>
<p>对于包含在其中的其它调用子函数, 如果存在自动释放的对象, 也会自动调用析构函数, 而且析构函数是比catch先调用的. 但是对于不会自动释放的对象, 就需要我们注意它的释放情况了.</p>
<blockquote>
<p>Debug的版本会略有不同.  MSVC版本不一样也可能不同</p>
</blockquote>
<h2 id="msvc举例-win11"><a href="#msvc举例-win11" class="headerlink" title="msvc举例(win11)"></a>msvc举例(win11)</h2><p>iassam.dll里</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712112112479.png" alt="1712112112479"></p>
<p>触发异常, 理论上应该处理 v12, v9, v11, 跟踪其struc后:</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712112164618.png" alt="1712112164618"></p>
<p><img src="/images/CPlusPlus_Exception.assets/1712112155063.png" alt="1712112155063"></p>
<p>可以看到有三个释放操作的rva. 所以它触发异常后, 应该就会调用这些析构操作.</p>
<p>上层函数<code>ChangePassword::onSyncRequest</code>:</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712112295271.png" alt="1712112295271"></p>
<p><img src="/images/CPlusPlus_Exception.assets/1712113662570.png" alt="1712113662570"></p>
<p>可以看到, 下半截是catch相关的操作, 上半截是析构相关的操作. 因此这个函数有<code>try catch</code>.</p>
<p>而调试对栈回溯里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00 00000097`ea97f020 00007ff9`e6a76ad2     iassam!ChangePassword::doChangePassword+0x9c</span><br><span class="line">01 00000097`ea97f090 00007ff9`e6a759dc     iassam!ChangePassword::onSyncRequest+0xb2</span><br><span class="line">02 00000097`ea97f0e0 00007ff9`e6a75948     iassam!IASTL::IASRequestHandlerSync::onAsyncRequest+0x7c</span><br><span class="line">03 00000097`ea97f110 00007ff9`e846311c     iassam!IASTL::IASRequestHandler::OnRequest+0xa8</span><br><span class="line">04 00000097`ea97f140 00007ff9`e8462e3f     iaspolcy!Pipeline::executeNext+0x154</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>对这些位置下断点, 在<code>ChangePassword::doChangePassword</code>里面触发异常, 也可以看到最后返回的是<code>IASTL::IASRequestHandlerSync::onAsyncRequest+0x7C 即 7ff9e6a759dc</code>的位置.</p>
<h2 id="旧版本msvc举例-server-2016"><a href="#旧版本msvc举例-server-2016" class="headerlink" title="旧版本msvc举例(server 2016)"></a>旧版本msvc举例(server 2016)</h2><p><img src="/images/CPlusPlus_Exception.assets/1712114532284.png" alt="1712114532284"></p>
<p><img src="/images/CPlusPlus_Exception.assets/1712114562160.png" alt="1712114562160"></p>
<p>这里只有个rva <code>stru_1800321D0</code>, 跟入:</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712114602198.png" alt="1712114602198"></p>
<p><code>stru_180033B7C</code>,<code>stru_180033B9C</code> 就是上一个图里的下半截, 分别是析构函数, 和catch相关的函数.</p>
<h2 id="导览图方法"><a href="#导览图方法" class="headerlink" title="导览图方法"></a>导览图方法</h2><p><img src="/images/CPlusPlus_Exception.assets/1712115551300.png" alt="1712115551300"></p>
<p>在目标函数里直接ida看导览图, 就可以看到ida识别的异常处理流. </p>
<p>析构操作<strong>可能</strong>会以这样的形式存在:</p>
<p><img src="/images/CPlusPlus_Exception.assets/1712115649867.png" alt="1712115649867"></p>
<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><p><a target="_blank" rel="noopener" href="https://www.openrce.org/articles/full_view/21">https://www.openrce.org/articles/full_view/21</a> 这篇文章更详细地介绍了具体的情况, 我没有完全照着来, 有兴趣可以自己看一下.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2023/10/16/sqlserver-dos-CVE-2023-36728/" class="next">下一篇</a></div><div id="container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><div id="gitalk-container"></div><script>const gitalk = new Gitalk({
    clientID: '28b1a73c3ed656a9a85d',     
    clientSecret: '59837bb4cbe7b2f12df366fdbcb37fa4ba084d44',     
    id: 'Tue Apr 02 2024 16:56:52 GMT+0800',    
    repo: 'blog-comment',     
    owner: '474172261',     
    admin: '474172261',     
})   
gitalk.render('gitalk-container')</script><div class="copyright"><p>© 2015 - 2024 <a href="http://474172261.github.io">VictorV</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>