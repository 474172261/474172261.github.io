<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 如何给qemu编译配置pvrdma设备 · VictorV的小博客</title><meta name="description" content="如何给qemu编译配置pvrdma设备 - VictorV"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://474172261.github.io/atom.xml" title="VictorV的小博客"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="VictorV的小博客" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/vv474172261" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/474172261" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">如何给qemu编译配置pvrdma设备</h1><div class="post-info">2022年6月17日</div><div class="post-content"><p>缘起于我在审计源码时找到pvrdma的一个bug, 因此需要构建一个pvrdma设备来测试, 但是呢, 因为rdma硬件设备很贵, 所以测试只能用模拟的rdma设备, 这里面, 主要使用的是soft-RoCE类型的模拟设备.</p>
<p>本身这件事不算困难, 奈何网上的资料太少了, 导致我在这方面栽了不少跟头, 分享出来, 希望能够帮助到大家.</p>
<span id="more"></span> 

<h2 id="准备rdma相关驱动"><a href="#准备rdma相关驱动" class="headerlink" title="准备rdma相关驱动"></a>准备rdma相关驱动</h2><p>最简单的方法, 使用centos7或者centos8, 执行<code>lsmod |grep rdma</code>, 如果存在rdma_rxe结果, 说明系统已经有了rdma相关驱动. 可以直接跳过这个准备步骤.</p>
<p>另一种方法, 编译一个新内核, 再编译用户态模块. 坑爹之路就此开始. </p>
<p>以下以ubuntu 16.04为例, 按照soft-RoCE的<a target="_blank" rel="noopener" href="https://github.com/SoftRoCE/rxe-dev/wiki/rxe-dev:-Home">wiki</a>指示开始编译内核.</p>
<ol>
<li><p>下载<a target="_blank" rel="noopener" href="https://github.com/SoftRoCE/rxe-dev/tree/rxe_submission_v18">此项目</a>的v18分支. (按我的理解, 直接下载其它kernel源码来编译也是ok的, 没必要非得用这个, 我没有测试, 就不清楚行不行了)</p>
</li>
<li><p>准备相关编译组件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br><span class="line">sudo apt-get install libncurses5-dev</span><br><span class="line">sudo apt-get install libssl-dev</span><br><span class="line">sudo apt-get install libibcm1 libibcm-dev ibverbs-utils libibverbs-dev </span><br><span class="line">sudo apt-get install libibverbs1 librdmacm-dev librdmacm1 rdmacm-utils </span><br><span class="line">sudo apt-get install libswitch-perl</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入项目, 开始配置编译选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /boot/config-`<span class="built_in">uname</span> -r` .config</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>弹出一个配置界面, 输入**&#x2F;<strong>, 并键入</strong>RXE**, 会得到如下结果:</p>
<p><img src="/images/configure-pvrdma-for-qemu.assets/image-20210525145220219.png" alt="image-20210525145220219"></p>
<p>按1, 跳转到改选项, 按M启用改模块, 之后回到这个配置的主界面保存配置, 再退出</p>
<p><img src="/images/configure-pvrdma-for-qemu.assets/image-20210525145317380.png" alt="image-20210525145317380"></p>
</li>
<li><p>开始编译并安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo make -j 4 <span class="comment"># 此处的4是cpu的个数, 不要超过它, 不然编译可能更慢</span></span><br><span class="line">sudo make modules_install</span><br><span class="line">sudo make install</span><br><span class="line">sudo make headers_install INSTALL_HDR_PATH=/usr</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启并使用新编译的内核</p>
</li>
<li><p>下载<a target="_blank" rel="noopener" href="https://github.com/SoftRoCE/librxe-dev">用户态项目</a>文件, 解压后进入目录</p>
</li>
<li><p>编译并配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./configure --libdir=/usr/lib64/ --prefix=</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">ln</span> -s /usr/lib64/librxe.a /usr/lib/librxe.a</span><br><span class="line">sudo <span class="built_in">ln</span> -s /usr/lib64/librxe.la /usr/lib/librxe.la</span><br><span class="line">sudo <span class="built_in">ln</span> -s /usr/lib64/librxe-rdmav2.so /usr/lib/librxe-rdmav2.so</span><br><span class="line">sudo <span class="built_in">ln</span> -s /usr/lib64/librxe.so /usr/lib/librxe.so</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用下列命令查看状态, 可能是如下效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rxe_cfg status</span><br><span class="line">  Name    Link  Driver   Speed   NMTU  IPv4_addr        RDEV  RMTU          </span><br><span class="line">  ens160  <span class="built_in">yes</span>   vmxnet3  10GigE  1500  192.168.170.129  </span><br></pre></td></tr></table></figure>
</li>
<li><p>执行下列命令添加网卡并查看状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ rxe_cfg add ens160</span><br><span class="line">$ rxe_cfg start</span><br><span class="line">$ ibv_devices</span><br><span class="line">    device          	   node GUID</span><br><span class="line">    ------          	----------------</span><br><span class="line">    rxe0            	020c29fffeee3b66</span><br><span class="line">$ ibv_devinfo</span><br><span class="line">hca_id:	rxe0</span><br><span class="line">	transport:			InfiniBand (0)</span><br><span class="line">	fw_ver:				0.0.0</span><br><span class="line">	node_guid:			020c:29ff:feee:3b66</span><br><span class="line">	sys_image_guid:			0000:0000:0000:0000</span><br><span class="line">	vendor_id:			0x0000</span><br><span class="line">	vendor_part_id:			0</span><br><span class="line">	hw_ver:				0x0</span><br><span class="line">	phys_port_cnt:			1</span><br><span class="line">		port:	1</span><br><span class="line">			state:			PORT_ACTIVE (4)</span><br><span class="line">			max_mtu:		4096 (5)</span><br><span class="line">			active_mtu:		1024 (3)</span><br><span class="line">			sm_lid:			0</span><br><span class="line">			port_lid:		0</span><br><span class="line">			port_lmc:		0x00</span><br><span class="line">			link_layer:		Ethernet</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试网络状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ibv_rc_pingpong -d rxe0 -g 1</span><br><span class="line"><span class="built_in">local</span> address:  LID 0x0000, QPN 0x000011, PSN 0x29338a, GID fe80::12cb:883b:5ccf:e656</span><br></pre></td></tr></table></figure>

<p>另外开启一个bash, 执行<code>ibv_rc_pingpong -d rxe0 -g 1 127.0.0.1</code></p>
<p>这时候server端会多出一行输出:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">remote address: LID 0x0000, QPN 0x000012, PSN 0xe63ffc, GID fe80::12cb:883b:5ccf:e656</span><br></pre></td></tr></table></figure>

<p>client端会得到如下输出:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">local address:  LID 0x0000, QPN 0x000012, PSN 0xe63ffc, GID fe80::12cb:883b:5ccf:e656</span><br><span class="line">  remote address: LID 0x0000, QPN 0x000011, PSN 0x29338a, GID fe80::12cb:883b:5ccf:e656</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="配置qemu编译选项"><a href="#配置qemu编译选项" class="headerlink" title="配置qemu编译选项"></a>配置qemu编译选项</h2><ol>
<li><p>修改qemu项目中如下文件<code>contrib/rdmacm-mux/meson.build</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  executable(&#x27;rdmacm-mux&#x27;, files(&#x27;main.c&#x27;),</span><br><span class="line">             dependencies: [glib, libumad],</span><br><span class="line">             build_by_default: true,</span><br><span class="line">             install: false)</span><br><span class="line">改为</span><br><span class="line">  executable(&#x27;rdmacm-mux&#x27;, files(&#x27;main.c&#x27;),</span><br><span class="line">             dependencies: [glib, libumad],</span><br><span class="line">             build_by_default: true,</span><br><span class="line">             install: true)</span><br></pre></td></tr></table></figure>


</li>
<li><p>执行如下编译配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./configure --enable-rdma --enable-pvrdma --enable-kvm  --enable-debug  --target-list=x86_64-softmmu</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来就是make和make install了. 具体参考上一篇关于qemu编译的blog.</p>
</li>
</ol>
<h2 id="编译过程中可能遇到的问题"><a href="#编译过程中可能遇到的问题" class="headerlink" title="编译过程中可能遇到的问题"></a>编译过程中可能遇到的问题</h2><ol>
<li><p>出现如下提示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot; OpenFabrics librdmacm/libibverbs/libibumad not present.&quot; \</span><br><span class="line">&quot; Your options:&quot; \</span><br><span class="line">&quot;  (1) Fast: Install infiniband packages (devel) from your distro.&quot; \</span><br><span class="line">&quot;  (2) Cleanest: Install libraries from www.openfabrics.org&quot; \</span><br><span class="line">&quot;  (3) Also: Install softiwarp if you don&#x27;t have RDMA hardware&quot;</span><br></pre></td></tr></table></figure>

<p>查看项目build&#x2F;config.log文件, 查看出错原因. 我的主要错误是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if has error:config-temp/qemu-conf.c:1:27: fatal error: rdma/rdma_cma.h: No such file or directory</span><br></pre></td></tr></table></figure>

<p>通过执行<code>find / -name &quot;rdma_cma.h</code>对整个硬盘搜索rdma_cma.h文件, 发现没找到, 就去网上找了它所在的<a target="_blank" rel="noopener" href="https://github.com/ofiwg/librdmacm">librdmacm库</a>, 下载解压后, 使用<code>./autogen.sh &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</code>安装即可.</p>
</li>
<li><p><code>ERROR: Could not detect Ninja v1.7 or newer</code></p>
<p>这个应该是本机安装的ninja组件, 或者版本过低, 可以通过如下命令下载安装解决</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/ninja-build/ninja/releases/download/v1.8.2/ninja-linux.zip</span><br><span class="line">$ sudo unzip ninja-linux.zip -d /usr/local/bin/</span><br><span class="line">$ sudo update-alternatives --install /usr/bin/ninja ninja /usr/local/bin/ninja 1 --force</span><br><span class="line">输出:update-alternatives: using /usr/local/bin/ninja to provide /usr/bin/ninja (ninja) <span class="keyword">in</span> auto mode</span><br><span class="line">$ /usr/bin/ninja --version</span><br><span class="line">1.8.2</span><br></pre></td></tr></table></figure>


</li>
<li><p><code>../hw/block/virtio-blk.c:30:22: fatal error: scsi/sg.h: No such file or directory compilation terminated.</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://launchpadlibrarian.net/353523714/libc6-dev_2.23-0ubuntu10_amd64.deb</span><br><span class="line">$ dpkg -i libc6-dev_2.23-0ubuntu10_amd64.deb</span><br><span class="line">(Reading database ... 184747 files and directories currently installed.)</span><br><span class="line">Preparing to unpack libc6-dev_2.23-0ubuntu10_amd64.deb ...</span><br><span class="line">Unpacking libc6-dev:amd64 (2.23-0ubuntu10) over (2.23-0ubuntu3) ...</span><br><span class="line">dpkg: dependency problems prevent configuration of libc6-dev:amd64:</span><br><span class="line"> libc6-dev:amd64 depends on libc6 (= 2.23-0ubuntu10); however:</span><br><span class="line">  Version of libc6:amd64 on system is 2.23-0ubuntu3.</span><br><span class="line"> libc6-dev:amd64 depends on libc-dev-bin (= 2.23-0ubuntu10); however:</span><br><span class="line">  Version of libc-dev-bin on system is 2.23-0ubuntu3.</span><br><span class="line"></span><br><span class="line">dpkg: error processing package libc6-dev:amd64 (--install):</span><br><span class="line"> dependency problems - leaving unconfigured</span><br><span class="line">Errors were encountered <span class="keyword">while</span> processing:</span><br><span class="line"> libc6-dev:amd64</span><br><span class="line">$ apt -f install</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="启动参数"><a href="#启动参数" class="headerlink" title="启动参数"></a>启动参数</h2><ol>
<li><p>参照<a target="_blank" rel="noopener" href="https://github.com/qemu/qemu/blob/master/docs/pvrdma.txt">官方指导文档</a>, 需要保证ib_cm模块没有加载, 因此先卸载相关模块. 并且加载必要模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rmmod rdma_ucm rdma_cm ib_cm</span><br><span class="line">$ insmod ib_umad</span><br></pre></td></tr></table></figure>



<blockquote>
<p>注意, 默认情况下, rdmacm-mux文件的输出是调用的syslog, 建议改成printf 并把umad_open_port的返回结果输出出来, 以便找到失败原因.</p>
</blockquote>
</li>
<li><p>在执行上述操作前, 请确保已经执行过了<code>rxe_cfg start</code>操作.</p>
</li>
<li><p>执行下列命令, 创建所需socket</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-6.0.0/build/contrib/rdmacm-mux/rdmacm-mux -d rxe0</span><br><span class="line">unix_socket_path=/var/run/rdmacm-mux-rxe0-1 这行是改成<span class="built_in">printf</span>后会输出的内容.</span><br><span class="line">rdma-device-name=rxe0 这行是改成<span class="built_in">printf</span>后会输出的内容.</span><br><span class="line">rdma-device-port=1 这行是改成<span class="built_in">printf</span>后会输出的内容.</span><br><span class="line">Service started</span><br></pre></td></tr></table></figure></li>
<li><p>创建桥接网络</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get install uml-utilities</span><br><span class="line">$ tunctl -t tap0 -u `<span class="built_in">whoami</span>`</span><br><span class="line">$ <span class="built_in">chmod</span> 0666 /dev/net/tun 让所有用户可读</span><br><span class="line">$ ifconfig tap0 192.168.2.1 up 给tap0设置ip段</span><br><span class="line">添加防火墙规则</span><br><span class="line">$ <span class="built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">$ iptables -t nat -A POSTROUTING -j MASQUERADE</span><br></pre></td></tr></table></figure>
<p>  <a target="_blank" rel="noopener" href="https://zhou-yuxin.github.io/articles/2018/%E5%AE%89%E8%A3%85qemu-kvm%E4%BB%A5%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%A1%A5%E6%8E%A5%E7%BD%91%E7%BB%9C/index.html">参考网址</a></p>
</li>
<li><p>最后, qemu启动参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/local/bin/qemu-system-x86_64 -object memory-backend-ram,<span class="built_in">id</span>=mb1,size=1G,share=on -numa node,memdev=mb1 \</span><br><span class="line">-netdev tap,<span class="built_in">id</span>=mynet0,ifname=tap0,script=no,downscript=no \</span><br><span class="line">-device vmxnet3,netdev=mynet0,<span class="built_in">id</span>=net0,mac=52:54:00:e3:00:81,addr=0x10.0,multifunction=on  \</span><br><span class="line">-chardev socket,path=/var/run/rdmacm-mux-rxe0-1,<span class="built_in">id</span>=mads -device pvrdma,addr=0x10.1,ibdev=rxe0,netdev=net0,mad-chardev=mads \</span><br><span class="line">-m 1G -hda qemu-6.0.0/centos7.img --enable-kvm</span><br></pre></td></tr></table></figure>

<p>根据官方文档描述, pvrdma必须要三个参数: ibdev, netdev, mad-chardev, 并且<code>To support it, pvrdma device is composed of two PCI functions, an Ethernet device of type vmxnet3 on PCI slot 0 and a PVRDMA device on PCI slot 1.</code>, 即在slot 0必须是一个vmxnet3网卡, slot 1是pvrdma, 所以此处vmxnet3的pci地址给的是 0x10.0, 则pvrdma是0x10.1.</p>
</li>
</ol>
<h2 id="libvirt配置"><a href="#libvirt配置" class="headerlink" title="libvirt配置"></a>libvirt配置</h2><p>如果不想直接用命令启动qemu, 用libvirt也可</p>
<ol>
<li><p>假如已经存在一个格式为qcow2的虚拟机image文件了, 假设文件名为centos7.img</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">安装相关组件</span><br><span class="line">$ apt install libvirt libvirt-python libguestfs-tools virt-install</span><br><span class="line"></span><br><span class="line">启动相关服务</span><br><span class="line">$ systemctl <span class="built_in">enable</span> libvirtd</span><br><span class="line">$ systemctl start libvirtd</span><br><span class="line"></span><br><span class="line">查看桥接网卡</span><br><span class="line">$ brctl show</span><br><span class="line">bridge name	bridge <span class="built_in">id</span>		STP enabled	interfaces</span><br><span class="line">virbr0		8000.525400455887	<span class="built_in">yes</span>		virbr0-nic</span><br><span class="line"></span><br><span class="line">添加现成虚拟机</span><br><span class="line">$ virt-install --import --name vm1 \</span><br><span class="line">--memory 1024 --vcpus 1 --cpu host \</span><br><span class="line">--disk centos7.img,format=qcow2,bus=virtio \</span><br><span class="line">--network bridge=virbr0,model=virtio \</span><br><span class="line">--os-type=linux \</span><br><span class="line">--os-variant=centos7.0 \</span><br><span class="line">--nographics \</span><br><span class="line">--noautoconsole</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装后, 先关闭虚拟机, 然后在<code>/etc/libvirt/qemu/</code>目录下找到vm1.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span> <span class="attr">type</span>=<span class="string">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>vm2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">interface</span> <span class="attr">type</span>=<span class="string">&#x27;bridge&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mac</span> <span class="attr">address</span>=<span class="string">&#x27;56:b4:44:e9:62:dc&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span> <span class="attr">bridge</span>=<span class="string">&#x27;virbr0&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">model</span> <span class="attr">type</span>=<span class="string">&#x27;vmxnet3&#x27;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;pci&#x27;</span> <span class="attr">domain</span>=<span class="string">&#x27;0x0000&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0x00&#x27;</span> <span class="attr">slot</span>=<span class="string">&#x27;0x10&#x27;</span> <span class="attr">function</span>=<span class="string">&#x27;0x0&#x27;</span> <span class="attr">multifunction</span>=<span class="string">&#x27;on&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">  <span class="tag">&lt;<span class="name">qemu:commandline</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-object&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;memory-backend-ram,id=mb1,size=1G,share&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-numa&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;node,memdev=mb1&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-chardev&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;socket,path=/var/run/rdmacm-mux-rxe0-1,id=mads&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;-device&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">qemu:arg</span> <span class="attr">value</span>=<span class="string">&#x27;pvrdma,addr=10.1,ibdev=rxe0,netdev=bridge0,mad-chardev=mads&#x27;</span>/&gt;</span> 注意这里是10.1 必须和vmxnet3的bus=&#x27;0x00&#x27; slot=&#x27;0x10&#x27; function=&#x27;0x0&#x27; 对应, 保证bus相同, slot相同, 其中function: 0为vmxnet3, 1为pvrdma.</span><br><span class="line">  <span class="tag">&lt;/<span class="name">qemu:commandline</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此处的bridge0是哪一个我不是很确定, 需要的人得自己琢磨一下了. 我配置这里主要是为了获取vmxnet3的真实启动配置参数.</p>
</li>
</ol>
<p><strong>常见的virsh命令</strong>:</p>
<ul>
<li>列出所有虚拟机<br><code>virsh list --all</code></li>
<li>获取虚拟机信息<br><code>virsh dominfo vm1</code></li>
<li>关闭虚拟机<br><code>virsh shutdown vm1</code></li>
<li>启动虚拟机<br><code>virsh start vm1</code></li>
<li>虚拟机随宿主机启动而自动启动<br><code>virsh autostart vm1</code></li>
<li>安全重启虚拟机<br><code>virsh reboot vm1</code></li>
<li>重启虚拟机(不安全，hard reset)<br><code>virsh reset vm1</code></li>
<li>删除虚拟机<br><code>virsh shutdown vm1</code><br><code>virsh undefine vm1</code><br><code>virsh pool-destroy vm1</code></li>
</ul>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>一开始并不知道centos可以省去那么多麻烦, 在ubuntu上卡了很久很久, 问了Li Qiang大佬和官方的人, 也没有得到具体的配置方法, 最后总算是靠着一行行看配置文件找到失败原因, 并一一解决, 这里更不提那个softiWarp了, 这里虽然没用到, 但是那个错误提示里提到后, 我就以为需要配置它, 也踩了不少的坑 T-T. </p>
<p>在rdmacm-mux的编译和启动那一步也卡了很久, 不明白为什么启动不了server, 后来明白是自己给的设备名字不对, 并不是一个任意名字, 必须是设备名.</p>
<p>启动参数那也费了很多力气, 官方文档是用libvirt, 由于缺乏相关使用经验, 就先自己琢磨的参数, 后来实在有问题, 就用libvirt创建了虚拟机, 并修改了相关文件的配置, 添加成功命令, 并一步步找失败原因. </p>
<p>他们文档说是要让vmxnet3在slot 0, 但是并没有说怎么放到slot 0, 中间还遇到<code>PCI: single function device can&#39;t be populated in function 10.1</code>错误, 后来发现是vmxnet3缺少multifunction参数所致.</p>
<p>qemu官方文档真的太坑了, 信息给的少, 网上也缺乏相关资料, 只能自己琢磨, 唉, 坑啊~</p>
<p>最后呢, 是我发现的3个相关bug: <a target="_blank" rel="noopener" href="https://access.redhat.com/security/cve/cve-2021-3582">cve-2021-3582</a>, <a target="_blank" rel="noopener" href="https://access.redhat.com/security/cve/cve-2021-3607">cve-2021-3607</a>, <a target="_blank" rel="noopener" href="https://access.redhat.com/security/cve/cve-2021-3608">cve-2021-3608</a>, 虽然其中两个都有可能导致虚拟化逃逸, 但是现在没有任何厂商在用这个设备, 所以也就没什么实质性的危害.</p>
</div></article></div></main><footer><div class="paginator"><a href="/2022/06/17/build-blog/" class="prev">上一篇</a></div><div id="container"></div><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script><script>var gitment = new Gitment({
    id: 'Fri Jun 17 2022 19:38:05 GMT+0800',
    owner: '474172261',
    repo: 'blog-comment',
    oauth: {
        client_id: '28b1a73c3ed656a9a85d',
        client_secret: '7ce17c048ed2d7c61117b439fe94026bd380e126',
    },
})
gitment.render('container')</script><div class="copyright"><p>© 2015 - 2022 <a href="http://474172261.github.io">VictorV</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>