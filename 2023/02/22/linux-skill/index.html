<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Linux 使用技巧 · VictorV的小博客</title><meta name="description" content="Linux 使用技巧 - VictorV"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://474172261.github.io/atom.xml" title="VictorV的小博客"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="VictorV的小博客" type="application/atom+xml">
</head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://twitter.com/vv474172261" target="_blank" class="nav-list-link">TWITTER</a></li><li class="nav-list-item"><a href="https://github.com/474172261" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Linux 使用技巧</h1><div class="post-info">2023年2月22日</div><div class="post-content"><span id="more"></span>

<blockquote>
<p>不定期更新</p>
</blockquote>
<h2 id="两个linux文件互传"><a href="#两个linux文件互传" class="headerlink" title="两个linux文件互传"></a>两个linux文件互传</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ scp -r linux-2.6.26 root@(目标ip)IP:/usr/src/(假设放到/usr/src路径)</span><br></pre></td></tr></table></figure>

<h2 id="文件查找"><a href="#文件查找" class="headerlink" title="文件查找"></a>文件查找</h2><p>将当前目录及其子目录下所有文件后缀为 .c 的文件列出来:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ find . -name &quot;*.c&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>find默认不查找软链接的文件夹, 所以, 可以加<code>-L</code>解决这个问题, 这个很重要!!!!!!</p>
</blockquote>
<h2 id="将一个本地程序做成一个本地服务程序"><a href="#将一个本地程序做成一个本地服务程序" class="headerlink" title="将一个本地程序做成一个本地服务程序"></a>将一个本地程序做成一个本地服务程序</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ socat tcp-l:2333,reuseaddr,fork <span class="built_in">exec</span>:./pwn1</span><br></pre></td></tr></table></figure>
<p>服务端口在2333，使用nc 127.0.0.1 2333连接</p>
<h2 id="获取ubuntu当前内核的源码"><a href="#获取ubuntu当前内核的源码" class="headerlink" title="获取ubuntu当前内核的源码"></a>获取ubuntu当前内核的源码</h2><p>进入<a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/">lauchpad</a>, 分清你的系统名称, 比如 20.04 叫 Focal Fossa, 系统当前版本:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">uname</span> -r</span><br><span class="line">5.13.0-35-generic</span><br></pre></td></tr></table></figure>

<p>那么我们在页面的以下部分会看到以下部分的内容</p>
<p><strong>Active series and milestones</strong></p>
<ul>
<li><p><strong><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/jammy">22.04 “Jammy” series </a></strong>- development<br>Milestones: <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/jammy-updates">jammy-updates</a>, <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-22.04">ubuntu-22.04</a>, <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-22.04-beta">ubuntu-22.04-beta</a>, <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-22.03">ubuntu-22.03</a>, <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-22.02">ubuntu-22.02</a>, <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-22.04-feature-freeze">ubuntu-22.04-feature-freeze</a>, <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-22.01">ubuntu-22.01</a>, <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-21.12">ubuntu-21.12</a>, and <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-21.11">ubuntu-21.11</a></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/impish">21.10 “Impish” series </a></strong>- current<br>Milestones: <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/impish-updates">impish-updates</a></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/focal">20.04 “Focal” series </a></strong>- supported &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;<br>Milestones: <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/focal-updates">focal-updates</a> and <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-20.04.4">ubuntu-20.04.4</a></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/bionic">18.04 “Bionic” series </a></strong>- supported<br>Milestones: <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/bionic-updates">bionic-updates</a></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/xenial">16.04 “Xenial” series </a></strong>- supported<br>Milestones: <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/xenial-updates">xenial-updates</a></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/trusty">14.04 “Trusty” series </a></strong>- supported<br>Milestones: <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestone/ubuntu-14.04.6">ubuntu-14.04.6</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+series">All series</a> </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+milestones">All milestones</a></p>
</li>
</ul>
<p>点击其中的<code>focal series</code>, 会出现搜索框, 我们就搜索<code>linux-image-5.13.0-35-generic</code>, 会得到如下几个结果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> linux-image-5.13.0-35-generic: &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line">Signed kernel image generic</span><br><span class="line"> linux-image-5.13.0-35-generic-dbgsym:</span><br><span class="line">Signed kernel image generic</span><br><span class="line"> linux-image-5.13.0-35-generic-lpae:</span><br><span class="line">Linux kernel image for version 5.13.0 on ARM (hard float) SMP</span><br><span class="line"> linux-image-5.13.0-35-generic-lpae-dbgsym:</span><br><span class="line">Linux kernel debug image for version 5.13.0 on ARM (hard float) SMP</span><br><span class="line"> linux-image-5.13.0-35-generic-64k:</span><br><span class="line">Signed kernel image generic-64k</span><br><span class="line"> linux-image-5.13.0-35-generic-64k-dbgsym:</span><br><span class="line">Signed kernel image generic-64k</span><br></pre></td></tr></table></figure>

<p>选择第一个, 出现如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Signed kernel image generic</span><br><span class="line"> A kernel image for generic. This version of it is signed with</span><br><span class="line"> Canonical&#x27;s UEFI/Opal signing key.</span><br><span class="line"></span><br><span class="line">Source package</span><br><span class="line">linux-signed-hwe-5.13 5.13.0-35.40~20.04.1 source package in Ubuntu  &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span><br><span class="line"></span><br><span class="line">Published versions</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in amd64 (Updates)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in amd64 (Security)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in arm64 (Updates)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in arm64 (Security)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in armhf (Updates)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in armhf (Security)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in ppc64el (Updates)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in ppc64el (Security)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in s390x (Updates)</span><br><span class="line">linux-image-5.13.0-35-generic 5.13.0-35.40~20.04.1 in s390x (Security)</span><br></pre></td></tr></table></figure>

<p>此处我选Source package下的链接. 之后选择downloads里的tar.xz文件即可.</p>
<blockquote>
<p>这个版本的文件里包含的是一个下载脚本, 并没有包含完整的src文件. 所以还是需要想想其它办法直接获得文件最好.</p>
</blockquote>
<h2 id="快速转换图片格式，修改分辨率"><a href="#快速转换图片格式，修改分辨率" class="headerlink" title="快速转换图片格式，修改分辨率"></a>快速转换图片格式，修改分辨率</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ convert -resize 100x100 src.jpg dst.jpg</span><br><span class="line">$ convert -resize 50%x50% src.jpg dst.jpg</span><br></pre></td></tr></table></figure>

<h2 id="修改文件的用户"><a href="#修改文件的用户" class="headerlink" title="修改文件的用户"></a>修改文件的用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">查看归属：</span><br><span class="line">$ <span class="built_in">ls</span> -l file</span><br><span class="line"></span><br><span class="line">赋给用户hv</span><br><span class="line">$ <span class="built_in">chown</span> hv:hv file</span><br><span class="line"></span><br><span class="line">如果需要把某个文件夹下所有都付给某个用户</span><br><span class="line">$ <span class="built_in">chown</span> hv:hv -R <span class="built_in">dir</span>/*</span><br></pre></td></tr></table></figure>

<h2 id="使用audit记录创建的程序"><a href="#使用audit记录创建的程序" class="headerlink" title="使用audit记录创建的程序"></a>使用audit记录创建的程序</h2><p>audit是记录linux审计信息的内核模块。<br>他记录系统中的各种动作和事件，比如系统调用，文件修改，执行的程序，系统登入登出和记录所有系统中所有的事件。audit还可以将审计记录写入日志文件。</p>
<p>如果想记录新创建的process, 可以直接修改<code>/etc/audit/audit.rules</code>, 添加一行<code>-a task,always</code>, 之后通过<code>cat /var/log/audit/audit.log|grep EXECVE</code> 来筛选你想要的记录.</p>
<p>比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ auditctl -a exit,always -F arch=b64 -S execve 添加execve检测</span><br><span class="line">$ auditctl -D 删除所有规则</span><br></pre></td></tr></table></figure>



<p>更多可以参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/gean/p/13749550.html">linux监控工具audit</a></p>
<h2 id="修改terminal的显示路径"><a href="#修改terminal的显示路径" class="headerlink" title="修改terminal的显示路径"></a>修改terminal的显示路径</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>找到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## If this is an xterm set the title to user@host:dir</span><br><span class="line">case “$TERM” in</span><br><span class="line">xterm|rxvt)</span><br><span class="line">PS1=”\e]0;$debianchroot:+($debianchroot)\u@\h:\w\a$PS1”</span><br></pre></td></tr></table></figure>
<p>将PS1那行修改为(其实就是把w换成W)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS1=”[\u@\h:\W]\\$”</span><br></pre></td></tr></table></figure>

<h2 id="添加环境变量"><a href="#添加环境变量" class="headerlink" title="添加环境变量"></a>添加环境变量</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/home/victorv</span><br></pre></td></tr></table></figure>

<h2 id="创建terminal的快捷键"><a href="#创建terminal的快捷键" class="headerlink" title="创建terminal的快捷键"></a>创建terminal的快捷键</h2><p>如果是在kali，terminal是没有快捷键的，到设置的keyboard里面，添加自定义快捷键，键值为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gnome-terminal</span><br></pre></td></tr></table></figure>
<p>或者安装nautilus-open-terminal</p>
<h2 id="gdb改变汇编代码显示方式"><a href="#gdb改变汇编代码显示方式" class="headerlink" title="gdb改变汇编代码显示方式"></a>gdb改变汇编代码显示方式</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) set disas intel</span><br></pre></td></tr></table></figure>
<p>设置反汇编代码使用的指令集，可选择 intel 指令集或 AT&amp;T指令集.</p>
<h2 id="usb驱动相关"><a href="#usb驱动相关" class="headerlink" title="usb驱动相关"></a>usb驱动相关</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">查找usb驱动</span><br><span class="line">$ sudo lspci</span><br><span class="line">…</span><br><span class="line">02:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168B PCI Express Gigabit Ethernet controller (rev 01)</span><br><span class="line">$ find /sys | grep drivers.*02:00</span><br><span class="line"></span><br><span class="line">获取usb设备信息</span><br><span class="line">lsusb -t</span><br><span class="line"><span class="built_in">cat</span> /proc/bus/usb/devices</span><br><span class="line">lshw</span><br><span class="line"></span><br><span class="line">卸载usb驱动</span><br><span class="line">tree /sys/bus/usb/drivers</span><br><span class="line"><span class="built_in">echo</span> -n “1-1:1.0” &gt; /sys/bus/usb/drivers/ub/unbind</span><br></pre></td></tr></table></figure>

<h2 id="centos安装内核header"><a href="#centos安装内核header" class="headerlink" title="centos安装内核header"></a>centos安装内核header</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install kernel-devel-$(<span class="built_in">uname</span> -r) kernel-headers-$(<span class="built_in">uname</span> -r)</span><br></pre></td></tr></table></figure>
<p>如果遇到没有搜索结果, 可以做如下操作:</p>
<ol>
<li>查看当前版本<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos~]<span class="comment"># cat /etc/redhat-release</span></span><br><span class="line">CentOS Linux release 7.4.1708 (Core)</span><br></pre></td></tr></table></figure></li>
<li>修改文件<code>/etc/yum.repos.d/CentOS-Vault.repo</code>, 添加当前版本的以下信息:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[C(Your Version Number)-base] 比如 [C5.6-base]</span><br><span class="line">name=CentOS-(Your Version Number) - Base</span><br><span class="line">baseurl=http://vault.centos.org/(Your Version Number)/os/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-5</span><br><span class="line">enabled=1</span><br><span class="line"></span><br><span class="line">[C(Your Version Number-updates]</span><br><span class="line">name=CentOS-(Your Version Number) - Updates</span><br><span class="line">baseurl=http://vault.centos.org/(Your Version Number)/updates/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-5</span><br><span class="line">enabled=1</span><br><span class="line"></span><br><span class="line">示例:</span><br><span class="line">[C7.4.1708-base]</span><br><span class="line">name=CentOS-7.4.1708 - Base</span><br><span class="line">baseurl=https://vault.centos.org/7.4.1708/os/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line">enabled=1</span><br><span class="line"></span><br><span class="line">[C7.4.1708-updates]</span><br><span class="line">name=CentOS-7.4.1708 - Updates</span><br><span class="line">baseurl=https://vault.centos.org/7.4.1708/updates/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure></li>
</ol>
<p>之后再试一次install即可.</p>
<p>更多参考<a target="_blank" rel="noopener" href="http://wiki.r1soft.com/display/kb3/Finding+Old+kernel-devel+Packages+For+CentOS">Finding Old kernel-devel Packages For CentOS</a></p>
<h2 id="添加sudoer-并且取消密码"><a href="#添加sudoer-并且取消密码" class="headerlink" title="添加sudoer 并且取消密码"></a>添加sudoer 并且取消密码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">superuser ALL=(ALL) NOPASSWD:ALL</span><br><span class="line">superuser ALL=(ALL:ALL) ALL　<span class="comment">#不取消密码</span></span><br></pre></td></tr></table></figure>

<h2 id="创建ssh服务"><a href="#创建ssh服务" class="headerlink" title="创建ssh服务"></a>创建ssh服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install openssh-server openssh-clients</span><br><span class="line">$ chkconfig sshd on</span><br><span class="line">$ service sshd start</span><br><span class="line">$ netstat -tulpn | grep :22</span><br><span class="line">$ vi /etc/sysconfig/iptables -A RH-Firewall-1-INPUT -m state –state NEW -m tcp -p tcp –dport 22 -j ACCEPT</span><br></pre></td></tr></table></figure>

<h2 id="创建ftp-服务"><a href="#创建ftp-服务" class="headerlink" title="创建ftp 服务"></a>创建ftp 服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install vsftpd</span><br><span class="line">sudo service vsftpd restart</span><br><span class="line">chkconfig vsftpd on</span><br></pre></td></tr></table></figure>

<h2 id="ubuntu修改内核调试启动项"><a href="#ubuntu修改内核调试启动项" class="headerlink" title="ubuntu修改内核调试启动项"></a>ubuntu修改内核调试启动项</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/default/grub</span><br></pre></td></tr></table></figure>
<p>在屁股后面添加 kgdboc&#x3D;ttyS1,115200</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep menu /boot/grub/grub.cfg</span><br><span class="line">grub-reboot ‘1&gt;3’ </span><br></pre></td></tr></table></figure>
<p>第一个数字1代表第二行的submenu，第二个3代表submenu的第四个（从0开始）</p>
<h2 id="挂起一个进程"><a href="#挂起一个进程" class="headerlink" title="挂起一个进程"></a>挂起一个进程</h2><p>ctrl+z<br>fg 恢复</p>
<h2 id="打包、解压文件"><a href="#打包、解压文件" class="headerlink" title="打包、解压文件"></a>打包、解压文件</h2><p>解包使用x,打包使用c</p>
<p>tar.xz<br>解包:tar zxvf file.tar.xz 或者:xz -d file.tar.xz &amp;&amp; tar xvf file.tar<br>打包:tar zcvf file.tar.xz</p>
<p>.tar<br>解包：tar xvf FileName.tar<br>打包：tar cvf FileName.tar DirName<br>（注：tar是打包，不是压缩！）<br>———————————————<br>.gz<br>解压1：gunzip FileName.gz<br>解压2：gzip -d FileName.gz<br>压缩：gzip FileName</p>
<p>.tar.gz 和 .tgz<br>解压：tar zxvf FileName.tar.gz<br>压缩：tar zcvf FileName.tar.gz DirName<br>———————————————<br>.bz2<br>解压1：bzip2 -d FileName.bz2<br>解压2：bunzip2 FileName.bz2<br>压缩： bzip2 -z FileName</p>
<p>.tar.bz2<br>解压：tar jxvf FileName.tar.bz2<br>压缩：tar jcvf FileName.tar.bz2 DirName<br>———————————————<br>.bz<br>解压1：bzip2 -d FileName.bz<br>解压2：bunzip2 FileName.bz<br>压缩：未知</p>
<p>.tar.bz<br>解压：tar jxvf FileName.tar.bz<br>压缩：未知<br>———————————————<br>.Z<br>解压：uncompress FileName.Z<br>压缩：compress FileName<br>.tar.Z</p>
<p>解压：tar Zxvf FileName.tar.Z<br>压缩：tar Zcvf FileName.tar.Z DirName<br>———————————————<br>.zip<br>解压：unzip FileName.zip<br>压缩：zip FileName.zip DirName<br>———————————————<br>.rar<br>解压：rar x FileName.rar<br>压缩：rar a FileName.rar DirName<br>———————————————<br>.lha<br>解压：lha -e FileName.lha<br>压缩：lha -a FileName.lha FileName<br>———————————————<br>.rpm<br>解包：rpm2cpio FileName.rpm | cpio -div<br>———————————————<br>.deb<br>解包：ar p FileName.deb data.tar.gz | tar zxf -<br>———————————————<br>.tar .tgz .tar.gz .tar.Z .tar.bz .tar.bz2 .zip .cpio .rpm .deb .slp .arj .rar .ace .lha .lzh .lzx .lzs .arc .sda .sfx .lnx .zoo .cab .kar .cpt .pit .sit .sea<br>解压：sEx x FileName.*<br>压缩：sEx a FileName.* FileName</p>
<h2 id="单独重新编译一个内核模块"><a href="#单独重新编译一个内核模块" class="headerlink" title="单独重新编译一个内核模块"></a>单独重新编译一个内核模块</h2><p>当我们想修改内核某个模块,又不想重新make all的时候,可以这样操作.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make drivers/net/ethernet/intel/e1000/e1000.ko</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make drivers/net/ethernet/intel/e1000/</span><br></pre></td></tr></table></figure>

<h2 id="gcc-汇编"><a href="#gcc-汇编" class="headerlink" title="gcc 汇编"></a>gcc 汇编</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix # intel 汇编格式</span><br><span class="line">xor eax, eax</span><br><span class="line"></span><br><span class="line">.att_syntax prefix # att汇编格式</span><br><span class="line">movl %adx, %eax…</span><br></pre></td></tr></table></figure>

<p>一个简单的 t.s 文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix</span><br><span class="line">.global  test # 声明函数</span><br><span class="line">.global g_var # 声明全局变量</span><br><span class="line"></span><br><span class="line">.text # 以下是.text段</span><br><span class="line">test:</span><br><span class="line">    mov qword ptr[g_var], 12</span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">.data # 以下是.data段</span><br><span class="line">g_var: .quad 0 # 初始化变量为 0</span><br></pre></td></tr></table></figure>

<p>t.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">test</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">long</span> g_var;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    test();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, g_var);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是<code>t.cpp</code>, 记得使用<code>extern &quot;C&quot; int test(void);</code></p>
<p>编译链接:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c t.s</span><br><span class="line">gcc t.c t.o -o tt2</span><br></pre></td></tr></table></figure>

<p>如果是编写so文件, 记得在Makefile的命令中添加<code>-fstack-protector-all</code>, 否则, 会有个<code>execute stack</code>的flag在里面, 导致dlopen失败.</p>
<p>更多参考<a target="_blank" rel="noopener" href="https://renenyffenegger.ch/notes/development/languages/C-C-plus-plus/GCC/as/index">GNU assembler</a>, <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7190050/how-do-i-compile-the-asm-generated-by-gcc">How do I compile the asm generated by GCC?</a>, <a target="_blank" rel="noopener" href="https://cs.lmu.edu/~ray/notes/gasexamples/">GNU Assembler Examples</a></p>
<h2 id="编写linux驱动与汇编相关的tips"><a href="#编写linux驱动与汇编相关的tips" class="headerlink" title="编写linux驱动与汇编相关的tips"></a>编写linux驱动与汇编相关的tips</h2><p>如果想给驱动内联一个汇编文件的函数, 可以如下:</p>
<p><strong>Makefile</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">obj-m += Anyname.o</span><br><span class="line">KDIR:=/lib/modules/$(shell uname -r)/build</span><br><span class="line">MAKE:=make</span><br><span class="line">Anyname-objs := main.o test.o</span><br><span class="line">CFLAGS_main.o := -D_FORTIFY_SOURCE=<span class="number">0</span> -O0</span><br><span class="line"></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">	$(MAKE) -C $(KDIR) SUBDIRS=$(PWD) modules  </span><br><span class="line">clean:  </span><br><span class="line">	$(MAKE) -C $(KDIR) SUBDIRS=$(PWD) clean</span><br></pre></td></tr></table></figure>

<p><strong>main.c</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ioport.h&gt;</span> </span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>); </span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">test</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">test2</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">my_module_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  printk(<span class="string">&quot;module init done\n&quot;</span>);</span><br><span class="line">  printk(<span class="string">&quot;test:%d, %d\n&quot;</span>, test(), test2());</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">my_module_exit</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">  printk(<span class="string">&quot;module exit\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init( my_module_init );<span class="comment">//声明初始化函数</span></span><br><span class="line">module_exit( my_module_exit );</span><br></pre></td></tr></table></figure>

<p><strong>test.S</strong>: 这里后缀必须是大写的<strong>S</strong>, 额外的格式参考<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/177366bf7ceb35860281a6ebe824e42bf96fd95d/arch/x86/net/bpf_jit.S">arch&#x2F;x86&#x2F;net&#x2F;bpf_jit.S</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.intel_syntax noprefix #声明 intel 格式</span><br><span class="line">.text # 声明 .text 字段</span><br><span class="line">.global test # 声明函数</span><br><span class="line">test:</span><br><span class="line">mov rax,12</span><br><span class="line">ret</span><br><span class="line"></span><br><span class="line">.global test2 # 声明函数</span><br><span class="line">test2:</span><br><span class="line">mov rax, 8</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>如果想禁止gcc编译的驱动给某个函数优化, 可以使用<code>void __attribute__((optimize(&quot;O0&quot;)))  test(void)</code>, 这样这个函数就不会被优化了.</p>
<p>也可以采取如下方式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#pragma GCC push_options</span><br><span class="line">#pragma GCC optimize(&quot;O0&quot;)</span><br><span class="line">void test(void)&#123;</span><br><span class="line">  int i=0;</span><br><span class="line">  return i+1;</span><br><span class="line">&#125;</span><br><span class="line">#pragma GCC pop_options</span><br></pre></td></tr></table></figure>



<p><strong>额外的tips, 如果存在<code>if(var&amp;0x80000000)</code>这样的操作, var一定不要用<code>int</code>类型, 要用无符号! gcc会把判断直接优化成0!!!!!!!!</strong></p>
<h2 id="gcc-内联汇编语法示例"><a href="#gcc-内联汇编语法示例" class="headerlink" title="gcc 内联汇编语法示例"></a>gcc 内联汇编语法示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> __asm__ (&quot;movl %eax, %ebx\n\t&quot;</span><br><span class="line">          &quot;movq %%rax,%%rdx\n\t&quot; // 64bit operation</span><br><span class="line">          &quot;movl %ecx, $label(%edx,%ebx,$4)\n\t&quot;</span><br><span class="line">          &quot;movb %ah, (%ebx)&quot;);</span><br><span class="line">asm ( assembler template </span><br><span class="line">          : output operands                  /* optional */</span><br><span class="line">          : input operands                   /* optional */</span><br><span class="line">          : list of clobbered registers      /* optional */</span><br><span class="line">          );</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int a=10, b;</span><br><span class="line">asm (&quot;movl %1, %%eax; </span><br><span class="line">      movl %%eax, %0;&quot;</span><br><span class="line">     :&quot;=r&quot;(b)        /* output */</span><br><span class="line">     :&quot;r&quot;(a)         /* input */</span><br><span class="line">     :&quot;%eax&quot;         /* clobbered register */</span><br><span class="line">     );   </span><br></pre></td></tr></table></figure>

<p><strong>“&#x3D;r”(b)</strong> 的含义, 将输出放入倒变量b里(%0 代表第一个变量, 此处第一个变量是输出里的b, 所以%0就是b, %1是 a). r代表使用任意寄存器, 如果是其它寄存器, 参考如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+---+--------------------+</span><br><span class="line">| r |    Register(s)     |</span><br><span class="line">+---+--------------------+</span><br><span class="line">| a |   %eax, %ax, %al   |</span><br><span class="line">| b |   %ebx, %bx, %bl   |</span><br><span class="line">| c |   %ecx, %cx, %cl   |</span><br><span class="line">| d |   %edx, %dx, %dl   |</span><br><span class="line">| S |   %esi, %si        |</span><br><span class="line">| D |   %edi, %di        |</span><br><span class="line">+---+--------------------+</span><br></pre></td></tr></table></figure>

<p>如果是使用内存, 用 <strong>m</strong>.</p>
<p>其它指示标识:</p>
<blockquote>
<ol>
<li>“m” : A memory operand is allowed, with any kind of address that the machine supports in general.</li>
<li>“o” : A memory operand is allowed, but only if the address is offsettable. ie, adding a small offset to the address gives a valid address.</li>
<li>“V” : A memory operand that is not offsettable. In other words, anything that would fit the <code>m’ constraint but not the </code>o’constraint.</li>
<li>“i” : An immediate integer operand (one with constant value) is allowed. This includes symbolic constants whose values will be known only at assembly time.</li>
<li>“n” : An immediate integer operand with a known numeric value is allowed. Many systems cannot support assembly-time constants for operands less than a word wide. Constraints for these operands should use ’n’ rather than ’i’.</li>
<li>“g” : Any register, memory or immediate integer operand is allowed, except for registers that are not general registers.</li>
</ol>
</blockquote>
<p>x86指令独有:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1. &quot;r&quot; : Register operand constraint, look table given above.</span><br><span class="line">2. &quot;q&quot; : Registers a, b, c or d.</span><br><span class="line">3. &quot;I&quot; : Constant in range 0 to 31 (for 32-bit shifts).</span><br><span class="line">4. &quot;J&quot; : Constant in range 0 to 63 (for 64-bit shifts).</span><br><span class="line">5. &quot;K&quot; : 0xff.</span><br><span class="line">6. &quot;L&quot; : 0xffff.</span><br><span class="line">7. &quot;M&quot; : 0, 1, 2, or 3 (shifts for lea instruction).</span><br><span class="line">8. &quot;N&quot; : Constant in range 0 to 255 (for out instruction).</span><br><span class="line">9. &quot;f&quot; : Floating point register</span><br><span class="line">10. &quot;t&quot; : First (top of stack) floating point register</span><br><span class="line">11. &quot;u&quot; : Second floating point register</span><br><span class="line">12. &quot;A&quot; : Specifies the `a’ or `d’ registers. This is primarily useful for 64-bit integer values intended to be returned with the `d’ register holding the most significant bits and the `a’ register holding the least significant bits.</span><br></pre></td></tr></table></figure>

<p>特殊符合含义:</p>
<ol>
<li>“<strong>&#x3D;</strong>“ : 将结果写入到指定位置</li>
<li>“<strong>&amp;</strong>“ : Means that this operand is an earlyclobber operand, which is modified before the instruction is finished using the input operands. Therefore, this operand may not lie in a register that is used as an input operand or as part of any memory address. An input operand can be tied to an earlyclobber operand if its only use as an input occurs before the early result is written.</li>
</ol>
<p>示例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static inline char * strcpy(char * dest,const char *src)</span><br><span class="line">&#123;</span><br><span class="line">int d0, d1, d2;</span><br><span class="line">__asm__ __volatile__(  &quot;1:\tlodsb\n\t&quot;</span><br><span class="line">                       &quot;stosb\n\t&quot;</span><br><span class="line">                       &quot;testb %%al,%%al\n\t&quot;</span><br><span class="line">                       &quot;jne 1b&quot;</span><br><span class="line">                     : &quot;=&amp;S&quot; (d0), &quot;=&amp;D&quot; (d1), &quot;=&amp;a&quot; (d2)</span><br><span class="line">                     : &quot;0&quot; (src),&quot;1&quot; (dest) </span><br><span class="line">                     : &quot;memory&quot;);</span><br><span class="line">return dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们不希望编译器优化掉我们的某些特殊循环判断时:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">asm (&quot;l1:\tmovb (%0), %%al\n\t&quot;</span><br><span class="line">  &quot;cmp $0xcc, %%al\n\t&quot;</span><br><span class="line">  &quot;je l1&quot;</span><br><span class="line">  ::&quot;r&quot;(&amp;buffer[0x7f]));</span><br></pre></td></tr></table></figure>

<h2 id="禁用gcc的某个函数优化"><a href="#禁用gcc的某个函数优化" class="headerlink" title="禁用gcc的某个函数优化"></a>禁用gcc的某个函数优化</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#pragma GCC push_options</span><br><span class="line">#pragma GCC optimize(&quot;O0&quot;)</span><br><span class="line">void test(int a);</span><br><span class="line">  return a;</span><br><span class="line">&#125;</span><br><span class="line">#pragma GCC pop_options</span><br></pre></td></tr></table></figure>



<p>更多参考<a target="_blank" rel="noopener" href="http://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html">GCC-Inline-Assembly-HOWTO</a></p>
<h2 id="log至文件中"><a href="#log至文件中" class="headerlink" title="log至文件中"></a>log至文件中</h2><p>有时候看不到printf, 需要log到文件里, 就经常需要查阅怎么写, 比较烦人. 记录一下.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sl</span><span class="params">(<span class="type">char</span>* str)</span>&#123;</span><br><span class="line">    <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(*str++)&#123;</span><br><span class="line">        len++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">log2file</span><span class="params">(<span class="type">char</span> *fmt, ...)</span>&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    <span class="type">char</span> str[<span class="number">0x200</span>];</span><br><span class="line">    <span class="comment">// 请自己确保log的内容不超过0x200.</span></span><br><span class="line">    <span class="built_in">vsprintf</span>(str, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    fd = open(<span class="string">&quot;/tmp/mylog.log&quot;</span>, O_CREAT|O_WRONLY|O_APPEND, <span class="number">0777</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;create fail\n&quot;</span>);</span><br><span class="line">        fd = open(<span class="string">&quot;/tmp/mylog.log&quot;</span>, O_WRONLY|O_APPEND, <span class="number">0777</span>);</span><br><span class="line">        <span class="keyword">if</span>(fd==<span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="type">char</span> str2[<span class="number">0x200</span>];</span><br><span class="line">            <span class="built_in">sprintf</span>(str2, <span class="string">&quot;echo \&quot;%s\&quot;&gt; /tmp/mylog.log&quot;</span>, str);</span><br><span class="line">            system(str2);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;write\n&quot;</span>);</span><br><span class="line">    write(fd, str, sl(str));</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    log2file(<span class="string">&quot;hello:%x\n&quot;</span>, <span class="number">0x111231</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="centos7-代理yum"><a href="#centos7-代理yum" class="headerlink" title="centos7 代理yum"></a>centos7 代理yum</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release -y</span><br><span class="line">rpm -ivh https://mirrors.aliyun.com/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line">yum install -y proxychains-ng</span><br></pre></td></tr></table></figure>

<p>修改配置<code>vi /etc/proxychains.conf</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ProxyList]</span><br><span class="line"># add proxy here ...</span><br><span class="line"># meanwile</span><br><span class="line"># defaults set to &quot;tor&quot;</span><br><span class="line">socks5  192.168.150.1 7890</span><br></pre></td></tr></table></figure>

<p>代理yum</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&gt; proxychains4 yum install bpftrace</span><br></pre></td></tr></table></figure>

<h2 id="Centos6-国内源"><a href="#Centos6-国内源" class="headerlink" title="Centos6 国内源"></a>Centos6 国内源</h2><p>因为centos6.x停止维护了, 所以要找个能用的源很麻烦, 偶尔要设置又容易忘了, 在此记录一下</p>
<ol>
<li><p>下载</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-6.10.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑<code>/etc/yum.repos.d/CentOS-Base.repo</code>, 在vim里更改版本 <code>:%s/6.10/6.8/g</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># CentOS-Base.repo</span><br><span class="line"></span><br><span class="line">[base]</span><br><span class="line">name=CentOS-vault-6.10 - Base - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos-vault/6.10/os/$basearch/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos-vault/6.10/os/$basearch/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos-vault/6.10/os/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"> </span><br><span class="line">#released updates </span><br><span class="line">[updates]</span><br><span class="line">name=CentOS-vault-6.10 - Updates - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos-vault/6.10/updates/$basearch/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos-vault/6.10/updates/$basearch/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos-vault/6.10/updates/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"> </span><br><span class="line">#additional packages that may be useful</span><br><span class="line">[extras]</span><br><span class="line">name=CentOS-vault-6.10 - Extras - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos-vault/6.10/extras/$basearch/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos-vault/6.10/extras/$basearch/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos-vault/6.10/extras/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"> </span><br><span class="line">#additional packages that extend functionality of existing packages</span><br><span class="line">[centosplus]</span><br><span class="line">name=CentOS-vault-6.10 - Plus - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos-vault/6.10/centosplus/$basearch/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos-vault/6.10/centosplus/$basearch/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos-vault/6.10/centosplus/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"> </span><br><span class="line">#contrib - packages by Centos Users</span><br><span class="line">[contrib]</span><br><span class="line">name=CentOS-vault-6.10 - Contrib - mirrors.aliyun.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.aliyun.com/centos-vault/6.10/contrib/$basearch/</span><br><span class="line">        http://mirrors.aliyuncs.com/centos-vault/6.10/contrib/$basearch/</span><br><span class="line">        http://mirrors.cloud.aliyuncs.com/centos-vault/6.10/contrib/$basearch/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/centos-vault/RPM-GPG-KEY-CentOS-6</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果是centos7的, 记得还需要改<code>RPM-GPG-KEY-CentOS-6</code> 为 <code>RPM-GPG-KEY-CentOS-7</code></p>
</li>
</ol>
<p>接着:<code>yum clean all</code>, <code>yum makecahe</code>.</p>
<h2 id="Centos-7-5更新7-9"><a href="#Centos-7-5更新7-9" class="headerlink" title="Centos 7.5更新7.9"></a>Centos 7.5更新7.9</h2><ol>
<li>下载centos 7.9的ISO <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/">下载链接</a></li>
<li>把文件拷贝进去</li>
<li>挂载iso<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /mnt/cdrom</span><br><span class="line">$ mount ./CentOS-7-x86_64-DVD-2009.iso /mnt/cdrom</span><br></pre></td></tr></table></figure></li>
<li>更改源  <code>/etc/yum.repo.d/CentOS-Media.repo</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[c7-media]</span><br><span class="line">name=CentOS Media</span><br><span class="line">baseurl=file:///mnt/cdrom/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br></pre></td></tr></table></figure></li>
<li>更新<code>yum --disablerepo=* --enablerepo=c7-media update</code></li>
</ol>
<h3 id="Centos-6-x-安装python2-7"><a href="#Centos-6-x-安装python2-7" class="headerlink" title="Centos 6.x 安装python2.7"></a>Centos 6.x 安装python2.7</h3><ol>
<li><code>yum install openssl-devel</code></li>
<li>下载源码: <a target="_blank" rel="noopener" href="https://www.python.org/ftp/python/2.7.13/Python-2.7.13.tar.xz">python 2.7.13源码</a>,  解压源码<code>tar Jxf  Python-2.7.13.tar.xz</code> </li>
<li><code>./configure --prefix=/usr/local/python27 --enable-shared</code></li>
<li><code>make &amp;&amp; make install</code>, <code>ln -s /usr/local/python27/bin/python /usr/bin/python27</code></li>
<li><code>echo &quot;/usr/loca/python27/lib&quot; &gt;&gt;/etc/ld.so.conf</code>, 执行<code>ldconfig</code></li>
<li>直接运行<code>python27</code>, 如果正常运行就ok.</li>
</ol>
<h2 id="bash-语法"><a href="#bash-语法" class="headerlink" title="bash 语法"></a>bash 语法</h2><h3 id="引用命令行参数"><a href="#引用命令行参数" class="headerlink" title="引用命令行参数"></a>引用命令行参数</h3><p><strong>直接引用</strong></p>
<p>$1,$2….<br>如果超过9, ${10}<br>${1:-8} 如果不存在1位置的变量, 默认给8<br>${parameter:?word} 可以默认给字符串</p>
<p><strong>flags</strong></p>
<p>​&#96;&#96;&#96;bash<br>while getopts u:a:f: flag#选项后面的冒号表示该选项需要参数<br>do<br>    case “${flag}” in<br>        u) username&#x3D;${OPTARG};;#参数存在$OPTARG中<br>        a) age&#x3D;${OPTARG};;<br>        f) fullname&#x3D;${OPTARG};;<br>    esac<br>done<br>echo “Username: $username”;<br>echo “Age: $age”;<br>echo “Full Name: $fullname”;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">`sh userReg-flags.sh -f &#x27;John Smith&#x27; -a 25 -u john `</span><br><span class="line"></span><br><span class="line">getopts,它不支持长选项。 $OPTIND 表示当前argv索引位置.</span><br><span class="line"></span><br><span class="line">**$@**  </span><br><span class="line"></span><br><span class="line">​```bash</span><br><span class="line">i=1;</span><br><span class="line">for user in &quot;$@&quot; </span><br><span class="line">do</span><br><span class="line">    echo &quot;Username - $i: $user&quot;;</span><br><span class="line">    i=$((i + 1));</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<blockquote>
<p>$* ：和$@相同，但”$*“ 和 “$@”(加引号)并不同，”$*“将所有的参数解释成一个字符串，而”$@”是一个参数数组</p>
</blockquote>
<p><strong>shift operator</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">i=1;</span><br><span class="line">j=<span class="variable">$#</span>;<span class="comment"># $#是参数个数</span></span><br><span class="line"><span class="keyword">while</span> [ <span class="variable">$i</span> -le <span class="variable">$j</span> ] </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Username - <span class="variable">$i</span>: <span class="variable">$1</span>&quot;</span>;</span><br><span class="line">    i=$((i + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">shift</span> 1; <span class="comment">#移动默认的argv的索引. 此处移1位, $1就变了</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="if"><a href="#if" class="headerlink" title="if"></a>if</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if commands; then</span><br><span class="line">  commands</span><br><span class="line">[elif commands; then</span><br><span class="line">  commands...]</span><br><span class="line">[else</span><br><span class="line">  commands]</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>Operation</th>
<th>Effect</th>
</tr>
</thead>
<tbody><tr>
<td>[ ! EXPR ]</td>
<td>True if <strong>EXPR</strong> is false.</td>
</tr>
<tr>
<td>[ ( EXPR ) ]</td>
<td>Returns the value of <strong>EXPR</strong>. This may be used to override the normal precedence of operators.</td>
</tr>
<tr>
<td>[ EXPR1 -a EXPR2 ]</td>
<td>True if both <strong>EXPR1</strong> and <strong>EXPR2</strong> are true.</td>
</tr>
<tr>
<td>[ EXPR1 -o EXPR2 ]</td>
<td>True if either <strong>EXPR1</strong> or <strong>EXPR2</strong> is true.</td>
</tr>
<tr>
<td>[ <code>-a</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists.</td>
</tr>
<tr>
<td>[ <code>-b</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is a block-special file.</td>
</tr>
<tr>
<td>[ <code>-c</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is a character-special file.</td>
</tr>
<tr>
<td>[ <code>-d</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is a directory.</td>
</tr>
<tr>
<td>[ <code>-e</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists.</td>
</tr>
<tr>
<td>[ <code>-f</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is a regular file.</td>
</tr>
<tr>
<td>[ <code>-g</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and its SGID bit is set.</td>
</tr>
<tr>
<td>[ <code>-h</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is a symbolic link.</td>
</tr>
<tr>
<td>[ <code>-k</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and its sticky bit is set.</td>
</tr>
<tr>
<td>[ <code>-p</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is a named pipe (FIFO).</td>
</tr>
<tr>
<td>[ <code>-r</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is readable.</td>
</tr>
<tr>
<td>[ <code>-s</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and has a size greater than zero.</td>
</tr>
<tr>
<td>[ <code>-t</code> <code>FD</code> ]</td>
<td>True if file descriptor <code>FD</code> is open and refers to a terminal.</td>
</tr>
<tr>
<td>[ <code>-u</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and its SUID (set user ID) bit is set.</td>
</tr>
<tr>
<td>[ <code>-w</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is writable.</td>
</tr>
<tr>
<td>[ <code>-x</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is executable.</td>
</tr>
<tr>
<td>[ <code>-O</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is owned by the effective user ID.</td>
</tr>
<tr>
<td>[ <code>-G</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is owned by the effective group ID.</td>
</tr>
<tr>
<td>[ <code>-L</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is a symbolic link.</td>
</tr>
<tr>
<td>[ <code>-N</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and has been modified since it was last read.</td>
</tr>
<tr>
<td>[ <code>-S</code> <code>FILE</code> ]</td>
<td>True if <code>FILE</code> exists and is a socket.</td>
</tr>
<tr>
<td>[ <code>FILE1</code> <code>-nt</code> <code>FILE2</code> ]</td>
<td>True if <code>FILE1</code> has been changed more recently than <code>FILE2</code>, or if <code>FILE1</code> exists and <code>FILE2</code> does not.</td>
</tr>
<tr>
<td>[ <code>FILE1</code> <code>-ot</code> <code>FILE2</code> ]</td>
<td>True if <code>FILE1</code> is older than <code>FILE2</code>, or is <code>FILE2</code> exists and <code>FILE1</code> does not.</td>
</tr>
<tr>
<td>[ <code>FILE1</code> <code>-ef</code> <code>FILE2</code> ]</td>
<td>True if <code>FILE1</code> and <code>FILE2</code> refer to the same device and inode numbers.</td>
</tr>
<tr>
<td>[ <code>-o</code> OPTIONNAME ]</td>
<td>True if shell option “OPTIONNAME” is enabled.</td>
</tr>
<tr>
<td><code>[ -z</code> STRING ]</td>
<td>True of the length if “STRING” is zero.</td>
</tr>
<tr>
<td><code>[ -n</code> STRING ] or [ STRING ]</td>
<td>True if the length of “STRING” is non-zero.</td>
</tr>
<tr>
<td>[ STRING1 &#x3D;&#x3D; STRING2 ]</td>
<td>True if the strings are equal. “&#x3D;” may be used instead of “&#x3D;&#x3D;” for strict POSIX compliance.</td>
</tr>
<tr>
<td>[ STRING1 !&#x3D; STRING2 ]</td>
<td>True if the strings are not equal.</td>
</tr>
<tr>
<td>[ STRING1 &lt; STRING2 ]</td>
<td>True if “STRING1” sorts before “STRING2” lexicographically in the current locale.</td>
</tr>
<tr>
<td>[ STRING1 &gt; STRING2 ]</td>
<td>True if “STRING1” sorts after “STRING2” lexicographically in the current locale.</td>
</tr>
<tr>
<td>[ ARG1 OP ARG2 ]</td>
<td>“OP” is one of <code>-eq</code>, <code>-ne</code>, <code>-lt</code>, <code>-le</code>, <code>-gt</code> or <code>-ge</code>. These arithmetic binary operators return true if “ARG1” is equal to, not equal to, less than, less than or equal to, greater than, or greater than or equal to “ARG2”, respectively. “ARG1” and “ARG2” are integers.</td>
</tr>
</tbody></table>
<h2 id="编译Gnutls"><a href="#编译Gnutls" class="headerlink" title="编译Gnutls"></a>编译Gnutls</h2><p>基于Centos7</p>
<p>在<a target="_blank" rel="noopener" href="https://www.gnutls.org/download.html">gntls</a>下载<a target="_blank" rel="noopener" href="https://www.lysator.liu.se/~nisse/nettle/">libnettle</a> 和<a target="_blank" rel="noopener" href="https://gmplib.org/">gmplib</a></p>
<ol>
<li>先编译gmplib, 安装后, <code>export GMP_CFLAGS=&quot;-I/usr/local/include&quot; GMP_LIBS=&quot;-L/usr/local/lib -lgmp&quot;</code></li>
<li>编译安装nettle, <code>./configure --prefix=/usr --enable-static --enable-mini-gmp</code></li>
<li><code>export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig/:/usr/local/lib/pkgconfig/</code> 设置<code>pkg-config</code>的查找路径</li>
<li>设置lib路径, 编辑<code>/etc/ld.so.conf</code>, 添加一行<code>/usr/local/lib</code>, 执行<code>ldconfig -v</code></li>
<li>编译gnutls: <code>./configure --without-p11-kit</code></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://amon.org/gnutls">主要参考</a></p>
<h2 id="编译samba最新版"><a href="#编译samba最新版" class="headerlink" title="编译samba最新版"></a>编译samba最新版</h2><p>在安装好gnutls后, 安装需要的组件:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ yum install python36-dns</span><br><span class="line">$ yum install python36-markdown</span><br><span class="line">$ yum install perl</span><br><span class="line">$ yum -y install perl-CPAN</span><br><span class="line">$ yum -y install popt-devel</span><br><span class="line">$ perl -MCPAN -e <span class="string">&#x27;install JSON&#x27;</span></span><br><span class="line">To install modules, you need to configure a <span class="built_in">local</span> Perl library directory or</span><br><span class="line">escalate your privileges.  CPAN can <span class="built_in">help</span> you by bootstrapping the <span class="built_in">local</span>::lib</span><br><span class="line">module or by configuring itself to use <span class="string">&#x27;sudo&#x27;</span> (<span class="keyword">if</span> available).  You may also</span><br><span class="line">resolve this problem manually <span class="keyword">if</span> you need to customize your setup.</span><br><span class="line"></span><br><span class="line">What approach <span class="keyword">do</span> you want?  (Choose <span class="string">&#x27;local::lib&#x27;</span>, <span class="string">&#x27;sudo&#x27;</span> or <span class="string">&#x27;manual&#x27;</span>)</span><br><span class="line"> [<span class="built_in">local</span>::lib] &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 输入enter</span><br><span class="line"></span><br><span class="line">Autoconfigured everything but <span class="string">&#x27;urllist&#x27;</span>.</span><br><span class="line"></span><br><span class="line">Now you need to choose your CPAN mirror sites.  You can <span class="built_in">let</span> me</span><br><span class="line">pick mirrors <span class="keyword">for</span> you, you can select them from a list or you</span><br><span class="line">can enter them by hand.</span><br><span class="line"></span><br><span class="line">Would you like me to automatically choose some CPAN mirror</span><br><span class="line">sites <span class="keyword">for</span> you? (This means connecting to the Internet) [<span class="built_in">yes</span>] no &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 输入no</span><br><span class="line"></span><br><span class="line">Would you like to pick from the CPAN mirror list? [<span class="built_in">yes</span>] no &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 输入no</span><br><span class="line">Now you can enter your own CPAN URLs by hand. A <span class="built_in">local</span> CPAN mirror can be</span><br><span class="line">listed using a <span class="string">&#x27;file:&#x27;</span> URL like <span class="string">&#x27;file:///path/to/cpan/&#x27;</span></span><br><span class="line"></span><br><span class="line">CPAN.pm needs at least one URL <span class="built_in">where</span> it can fetch CPAN files from.</span><br><span class="line"></span><br><span class="line">Please enter your CPAN site: [] http://mirrors.ustc.edu.cn/CPAN/ &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; 输入这个网址, 配置国内的源</span><br></pre></td></tr></table></figure>

<p>上面的组件安装完成后, 就可以配置编译了:</p>
<p><code>./configure --enable-debug --prefix=/home/vv/install-smb-4.17.2 --with-shared-modules=&#39;!vfs_snapper&#39;</code></p>
<h2 id="Linux-Ptrace的权限问题"><a href="#Linux-Ptrace的权限问题" class="headerlink" title="Linux Ptrace的权限问题"></a>Linux Ptrace的权限问题</h2><p>如果想避免同用户使用ptrace调试, 可以设置<code>prctl(PR_SET_DUMPABLE, 1LL, 0LL, 0LL, 0LL) </code>, <a target="_blank" rel="noopener" href="https://www.rezilion.com/blog/the-race-to-limit-ptrace/">参考</a></p>
<p>与之相关的还有<code>/proc/sys/kernel/yama/ptrace_scope</code>, 这个也影响了ptrace的使用.</p>
<h2 id="OpenSSL技巧"><a href="#OpenSSL技巧" class="headerlink" title="OpenSSL技巧"></a>OpenSSL技巧</h2><p>如果想修改原始的send数据, <code>SSL_CTX_set_msg_callback(ctx, message_cb);</code>, 这个回调就是在send前触发.</p>
<p>如果想发送任意的加密数据, 可以使用<code>ssl-&gt;method-&gt;ssl_write_bytes(ssl, SSL3_RT_ALERT, data, data_length, &amp;written);</code> 去发送.</p>
<p>dtls server示例:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winsock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/ssl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/bio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> <span class="keyword">warning</span>(disable:4996)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PSK_KEY <span class="string">&quot;Key&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PSK_IDENTITY <span class="string">&quot;Ide&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;libcrypto.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;libssl.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib,<span class="string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ssl_st</span> &#123;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * protocol version (one of SSL2_VERSION, SSL3_VERSION, TLS1_VERSION,</span></span><br><span class="line"><span class="comment">     * DTLS1_VERSION)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> version;</span><br><span class="line">    <span class="comment">/* SSLv3 */</span></span><br><span class="line">    <span class="type">const</span> SSL_METHOD* method;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">ssl_method_st</span> // 通过逆向<span class="title">FireDaemon</span> <span class="title">OpenSSL</span> 3\<span class="title">bin</span>\<span class="title">libcrypto</span>-3-<span class="title">x64</span>.<span class="title">dll</span>得到的, 只针对<span class="title">sslv3</span>, <span class="title">openssl</span>的版本会有不同.</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> version;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> mask;</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_new)(ssl_st*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_clear)(ssl_st*);</span><br><span class="line">    <span class="type">void</span>(__fastcall* ssl_free)(ssl_st*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_accept)(ssl_st*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_connect)(ssl_st*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_read)(ssl_st*, <span class="type">void</span>*, <span class="type">unsigned</span> __int64, <span class="type">unsigned</span> __int64*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_peek)(ssl_st*, <span class="type">void</span>*, <span class="type">unsigned</span> __int64, <span class="type">unsigned</span> __int64*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_write)(ssl_st*, <span class="type">const</span> <span class="type">void</span>*, <span class="type">unsigned</span> __int64, <span class="type">unsigned</span> __int64*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_shutdown)(ssl_st*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_renegotiate)(ssl_st*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_renegotiate_check)(ssl_st*, <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_read_bytes)(ssl_st*, <span class="type">int</span>, <span class="type">int</span>*, <span class="type">unsigned</span> __int8*, <span class="type">unsigned</span> __int64, <span class="type">int</span>, <span class="type">unsigned</span> __int64*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_write_bytes)(ssl_st*, <span class="type">int</span>, <span class="type">const</span> <span class="type">void</span>*, <span class="type">unsigned</span> __int64, <span class="type">unsigned</span> __int64*);</span><br><span class="line">    <span class="type">int</span>(__fastcall* ssl_dispatch_alert)(ssl_st*);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">generate_cookie</span><span class="params">(SSL* ssl, <span class="type">unsigned</span> <span class="type">char</span>* cookie, <span class="type">unsigned</span> <span class="type">int</span>* cookie_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Generate a cookie */</span></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Seed the random number generator */</span></span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Generate a random cookie */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">        cookie[i] = rand() % <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Print the cookie */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Cookie: &quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02X&quot;</span>, cookie[i]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    *cookie_len = <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify_cookie</span><span class="params">(SSL* ssl, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* cookie, <span class="type">unsigned</span> <span class="type">int</span> cookie_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Verify the cookie */</span></span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">psk_server_cb</span><span class="params">(SSL* ssl, <span class="type">const</span> <span class="type">char</span>* identity,</span></span><br><span class="line"><span class="params">    <span class="type">unsigned</span> <span class="type">char</span>* psk, <span class="type">unsigned</span> <span class="type">int</span> max_psk_len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(identity, PSK_IDENTITY) != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unknown PSK identity\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(PSK_KEY) &gt; max_psk_len)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;PSK key is too long\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(psk, PSK_KEY, <span class="built_in">strlen</span>(PSK_KEY)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strlen</span>(PSK_KEY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_memory</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* mem, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* p = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)mem;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len; i += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%08zx  &quot;</span>, i);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; len) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, p[i + j]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; len) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, <span class="built_in">isprint</span>(p[i + j]) ? p[i + j] : <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//void message_cb(int write_p, int version,</span></span><br><span class="line"><span class="comment">//    int content_type, const void* buf,</span></span><br><span class="line"><span class="comment">//    size_t len, SSL* ssl, void* arg) &#123;</span></span><br><span class="line"><span class="comment">//    printf(&quot;-------------dump memory------------------\n&quot;);</span></span><br><span class="line"><span class="comment">//    print_memory(buf, len);</span></span><br><span class="line"><span class="comment">//    printf(&quot;-------------dump done====================\n&quot;);</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> g_need_change = <span class="number">0</span>;</span><br><span class="line"><span class="type">long</span> <span class="title function_">send_callback</span><span class="params">(BIO* bio, <span class="type">int</span> cmd, <span class="type">const</span> <span class="type">char</span>* argp, <span class="type">int</span> argi,</span></span><br><span class="line"><span class="params">    <span class="type">long</span> argl, <span class="type">long</span> ret)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cmd == BIO_CB_WRITE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_need_change) &#123;</span><br><span class="line">            <span class="type">char</span>* data = (<span class="type">char</span>*)argp;</span><br><span class="line">            *data = <span class="number">21</span>;<span class="comment">// NX_SECURE_TLS_ALERT</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(push,1)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_lwm2m_protocol</span><span class="params">(SSL* ssl)</span> &#123;</span><br><span class="line">    <span class="type">char</span>* buffer = (<span class="type">char</span>*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">0x1000</span>);</span><br><span class="line">    <span class="type">char</span>* data = buffer;</span><br><span class="line">    <span class="type">int</span> data_length = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> written = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    data = buffer;</span><br><span class="line">    *(data) = <span class="number">0</span>;<span class="comment">// not NX_SECURE_TLS_ALERT_LEVEL_WARNING</span></span><br><span class="line">    *(data + <span class="number">1</span>) = <span class="number">1</span>;<span class="comment">// not NX_SECURE_TLS_ALERT_CLOSE_NOTIFY</span></span><br><span class="line">    data_length = <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    ssl-&gt;method-&gt;ssl_write_bytes(ssl, SSL3_RT_ALERT, data, data_length, &amp;written);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//SSL_read(ssl, buffer, 0x1000);</span></span><br><span class="line">    Sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">coap_header</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> token_length : <span class="number">4</span>;</span><br><span class="line">        <span class="type">char</span> type : <span class="number">4</span>;</span><br><span class="line">        <span class="type">char</span> code;</span><br><span class="line">        <span class="type">short</span> id;<span class="comment">// ´ó¶ËÐò</span></span><br><span class="line"></span><br><span class="line">    &#125; *header;</span><br><span class="line">    header = (<span class="keyword">struct</span> coap_header *)buffer;</span><br><span class="line">    header-&gt;type = <span class="number">4</span>;<span class="comment">// NX_LWM2M_CLIENT_COAP_VERSION_1</span></span><br><span class="line">    header-&gt;code = <span class="number">2</span>; <span class="comment">// NX_LWM2M_CLIENT_COAP_REQUEST_POST</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ±ä³¤µÄ½á¹¹Ìå coap option header</span></span><br><span class="line">    data = buffer + <span class="number">4</span>;</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">char</span>*)data = (<span class="number">11</span>&lt;&lt;<span class="number">4</span>)|(<span class="number">2</span>);<span class="comment">// 11:NX_LWM2M_CLIENT_COAP_OPTION_URI_PATH, 2 for value length</span></span><br><span class="line">    *(data + <span class="number">1</span>) = <span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">    *(data + <span class="number">2</span>) = <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">char</span>*)(data+<span class="number">3</span>) = <span class="number">0xff</span>;<span class="comment">// 0xff:NX_LWM2M_CLIENT_COAP_PAYLOAD_MARKER, for NX_LWM2M_CLIENT_COAP_OPTION_NONE;</span></span><br><span class="line">    data_length = <span class="number">4</span> + <span class="number">4</span>;</span><br><span class="line">    SSL_write(ssl, buffer, data_length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SSL_read(ssl, buffer, 0x1000);</span></span><br><span class="line"></span><br><span class="line">    data = buffer;</span><br><span class="line">    *(data) = <span class="number">0</span>;<span class="comment">// not NX_SECURE_TLS_ALERT_LEVEL_WARNING</span></span><br><span class="line">    *(data + <span class="number">1</span>) = <span class="number">1</span>;<span class="comment">// not NX_SECURE_TLS_ALERT_CLOSE_NOTIFY</span></span><br><span class="line">    data_length = <span class="number">2</span>;</span><br><span class="line">    ssl-&gt;method-&gt;ssl_write_bytes(ssl, SSL3_RT_ALERT, data, data_length, &amp;written);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(pop)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    SSL_CTX* ctx;</span><br><span class="line">    SSL* ssl;</span><br><span class="line">    BIO* bio;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize OpenSSL */</span></span><br><span class="line">    SSL_library_init();</span><br><span class="line">    SSL_load_error_strings();</span><br><span class="line">    <span class="type">int</span> iResult;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize Winsock</span></span><br><span class="line">    iResult = WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line">    <span class="keyword">if</span> (iResult != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WSAStartup failed: %d\n&quot;</span>, iResult);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a new DTLS context */</span></span><br><span class="line">    ctx = SSL_CTX_new(DTLSv1_2_server_method());</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error creating DTLS context\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the PSK callback */</span></span><br><span class="line">    SSL_CTX_set_psk_server_callback(ctx, psk_server_cb);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//SSL_CTX_set_msg_callback(ctx, message_cb);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the cipher list to include only PSK-AES128-CCM8 */</span></span><br><span class="line">    <span class="keyword">if</span> (SSL_CTX_set_cipher_list(ctx, <span class="string">&quot;PSK-AES128-CCM8&quot;</span>) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error setting cipher list\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a new socket */</span></span><br><span class="line">    SOCKET sock = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (sock &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error creating socket\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Bind the socket to the specified port */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = htons(<span class="number">5784</span>);</span><br><span class="line">    addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">    <span class="keyword">if</span> (bind(sock, (<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr)) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error binding socket, %d\n&quot;</span>, GetLastError());</span><br><span class="line">        WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a new DTLS connection */</span></span><br><span class="line">    bio = BIO_new_dgram(sock, BIO_NOCLOSE);</span><br><span class="line">    <span class="keyword">if</span> (bio == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error creating DTLS connection\n&quot;</span>);</span><br><span class="line">        WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ssl = SSL_new(ctx);</span><br><span class="line">    <span class="keyword">if</span> (ssl == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error creating DTLS connection\n&quot;</span>);</span><br><span class="line">        WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SSL_set_bio(ssl, bio, bio);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set the DTLS cookie generation and verification callbacks */</span></span><br><span class="line">    SSL_CTX_set_cookie_generate_cb(ctx, generate_cookie);</span><br><span class="line">    SSL_CTX_set_cookie_verify_cb(ctx, verify_cookie);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//BIO_set_callback(bio, send_callback);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Wait for a DTLS client to connect */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">client_addr</span> =</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Waiting for DTLS client to connect...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ret = DTLSv1_listen(ssl, (BIO_ADDR *) &amp; client_addr);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Error: %s\n&quot;</span>, ERR_error_string(ERR_get_error(), <span class="literal">NULL</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (ret &lt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Perform the DTLS handshake */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Performing DTLS handshake...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (SSL_accept(ssl) &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error performing DTLS handshake\n&quot;</span>);</span><br><span class="line">        WSACleanup();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;DTLS handshake complete\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Communicate with the DTLS client */</span></span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line"></span><br><span class="line">    handle_lwm2m_protocol(ssl);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Clean up */</span></span><br><span class="line">    SSL_free(ssl);</span><br><span class="line">    SSL_CTX_free(ctx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="openssl-renegotiate"><a href="#openssl-renegotiate" class="headerlink" title="openssl renegotiate"></a>openssl renegotiate</h3><p>当完成tls握手后, 如果你想触发renegotiate操作, 可以如下操作:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> ret = SSL_renegotiate(ssl);</span><br><span class="line"><span class="keyword">if</span> (ret) &#123;</span><br><span class="line">    ret = SSL_do_handshake(ssl);<span class="comment">// 发送 hello request请求</span></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        SSL_read(ssl, buffer, <span class="number">1024</span>);<span class="comment">// 如果目标发的消息没有处理完, 不会进行握手</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SSL_renegotiate</code> 设置重协商标志, <code>SSL_do_handshake</code> 发送加密的hello request请求. 如果client正常处理, 就应该返回一个加密的hello消息. 后续, 调用<code>SSL_read</code> 来触发新的握手协商. <strong>需要注意的时, 如果连接里有未读取的数据, 需要读到client回执的hello消息时才会触发握手操作!</strong></p>
<p>如果只是想简单测试, 可以用openssl程序实现, 下面的命令加载一个openssl server, 读取密钥和证书, 监听443.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; openssl.exe s_server -accept 443 -cert D:\tmp\cert.pem -key D:\tmp\key.pem</span><br><span class="line">Using default temp DH parameters</span><br><span class="line">ACCEPT</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输入<code>r</code>然后按<code>Enter</code>, 就可以让server给client发送重协商操作. </p>
<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/-27X5ZHTeA05r2hquHjy6Q">tls重协商攻击</a></p>
<p><a target="_blank" rel="noopener" href="https://www.linuxjournal.com/article/5487">An Introduction to OpenSSL Programming, Part II of II</a>, 这个文章很老旧了, 代码会有不对的地方.</p>
<h3 id="schannel-renegotiate的实现"><a href="#schannel-renegotiate的实现" class="headerlink" title="schannel renegotiate的实现"></a>schannel renegotiate的实现</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Renegotiation</span><span class="params">(SOCKET Server_Socket)</span> &#123;</span><br><span class="line">    TimeStamp         Lifetime;</span><br><span class="line">    SecBufferDesc     OutBuffDesc;</span><br><span class="line">    SecBuffer         OutSecBuff[<span class="number">2</span>];</span><br><span class="line">    SecBufferDesc     InBuffDesc;</span><br><span class="line">    SecBuffer         InSecBuff[<span class="number">2</span>];</span><br><span class="line">    ULONG             Attribs = <span class="number">0</span>;</span><br><span class="line">    SECURITY_STATUS           Status;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> cbIn = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    SecBufferDesc   OutBuffer;</span><br><span class="line">    SecBuffer       OutBuffers[<span class="number">1</span>];</span><br><span class="line">    DWORD           dwSSPIFlags;</span><br><span class="line">    DWORD           dwSSPIOutFlags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//DWORD dwType = SCHANNEL_RENEGOTIATE;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//OutBuffers[0].pvBuffer = &amp;dwType;</span></span><br><span class="line">    <span class="comment">//OutBuffers[0].BufferType = SECBUFFER_TOKEN;</span></span><br><span class="line">    <span class="comment">//OutBuffers[0].cbBuffer = sizeof(dwType);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//OutBuffer.cBuffers = 1;</span></span><br><span class="line">    <span class="comment">//OutBuffer.pBuffers = OutBuffers;</span></span><br><span class="line">    <span class="comment">//OutBuffer.ulVersion = SECBUFFER_VERSION;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//Status = ApplyControlToken(&amp;hctxt, &amp;OutBuffer);</span></span><br><span class="line">    <span class="comment">//if (FAILED(Status)) &#123;</span></span><br><span class="line">    <span class="comment">//    SetLastError(Status);</span></span><br><span class="line">    <span class="comment">//    LogError(&quot;fail to get controll data&quot;);</span></span><br><span class="line">    <span class="comment">//    return 0;</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    dwSSPIFlags = ASC_REQ_SEQUENCE_DETECT |</span><br><span class="line">        ASC_REQ_REPLAY_DETECT |</span><br><span class="line">        ASC_REQ_CONFIDENTIALITY |</span><br><span class="line">        ASC_REQ_EXTENDED_ERROR |</span><br><span class="line">        ASC_REQ_ALLOCATE_MEMORY |</span><br><span class="line">        ASC_REQ_STREAM;</span><br><span class="line"></span><br><span class="line">    InSecBuff[<span class="number">0</span>].BufferType = SECBUFFER_EMPTY;</span><br><span class="line">    InSecBuff[<span class="number">0</span>].pvBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    InSecBuff[<span class="number">0</span>].cbBuffer = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    InBuffDesc.ulVersion = SECBUFFER_VERSION;</span><br><span class="line">    InBuffDesc.cBuffers = <span class="number">1</span>;</span><br><span class="line">    InBuffDesc.pBuffers = InSecBuff;</span><br><span class="line"></span><br><span class="line">    OutBuffers[<span class="number">0</span>].BufferType = SECBUFFER_TOKEN;</span><br><span class="line">    OutBuffers[<span class="number">0</span>].pvBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    OutBuffers[<span class="number">0</span>].cbBuffer = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    OutBuffer.ulVersion = SECBUFFER_VERSION;</span><br><span class="line">    OutBuffer.cBuffers = <span class="number">1</span>;</span><br><span class="line">    OutBuffer.pBuffers = OutBuffers;</span><br><span class="line"></span><br><span class="line">    Status = AcceptSecurityContext(</span><br><span class="line">        &amp;hcred,</span><br><span class="line">        &amp;hctxt,</span><br><span class="line">        &amp;InBuffDesc,</span><br><span class="line">        dwSSPIFlags,</span><br><span class="line">        SECURITY_NATIVE_DREP,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;OutBuffer,</span><br><span class="line">        &amp;dwSSPIOutFlags,</span><br><span class="line">        &amp;Lifetime);</span><br><span class="line">    <span class="keyword">if</span> (FAILED(Status)) &#123;</span><br><span class="line">        SetLastError(Status);</span><br><span class="line">        LogError(<span class="string">&quot;fail to get hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发送hello request 给client, client解密后会是SEC_I_RENEGOTIATE, 会调用InitializeSecurityContext, 然后发送消息过来</span></span><br><span class="line">    <span class="keyword">if</span> (!SendBytes(</span><br><span class="line">        Server_Socket,</span><br><span class="line">        (BYTE*)(OutBuffers[<span class="number">0</span>].pvBuffer),</span><br><span class="line">        OutBuffers[<span class="number">0</span>].cbBuffer))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;send message failed. \n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ReceiveMsg(<span class="comment">// 接收client发来的加密hello消息</span></span><br><span class="line">        Server_Socket,</span><br><span class="line">        g_pInBuf,</span><br><span class="line">        g_cbMaxMessage,</span><br><span class="line">        &amp;cbIn))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>(FALSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SecBuffer security_buffers[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    SecBufferDesc security_buffers_desc;</span><br><span class="line">    security_buffers[<span class="number">0</span>].BufferType = SECBUFFER_DATA;</span><br><span class="line">    security_buffers[<span class="number">0</span>].pvBuffer = g_pInBuf;</span><br><span class="line">    security_buffers[<span class="number">0</span>].cbBuffer = cbIn;</span><br><span class="line">    security_buffers[<span class="number">1</span>].BufferType = SECBUFFER_EMPTY;</span><br><span class="line">    security_buffers[<span class="number">2</span>].BufferType = SECBUFFER_EMPTY;</span><br><span class="line">    security_buffers[<span class="number">3</span>].BufferType = SECBUFFER_EMPTY;</span><br><span class="line"></span><br><span class="line">    security_buffers_desc.cBuffers = <span class="keyword">sizeof</span>(security_buffers) / <span class="keyword">sizeof</span>(security_buffers[<span class="number">0</span>]);</span><br><span class="line">    security_buffers_desc.pBuffers = security_buffers;</span><br><span class="line">    security_buffers_desc.ulVersion = SECBUFFER_VERSION;</span><br><span class="line"></span><br><span class="line">    Status = DecryptMessage(&amp;hctxt, &amp;security_buffers_desc, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Status != SEC_I_RENEGOTIATE) &#123;<span class="comment">// 解密后应该是SEC_I_RENEGOTIATE消息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SecBuffer* pDataBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    SecBuffer* pExtraBuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pDataBuffer == <span class="literal">NULL</span> &amp;&amp; security_buffers[i].BufferType == SECBUFFER_DATA) &#123;</span><br><span class="line">            pDataBuffer = &amp;security_buffers[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pExtraBuffer == <span class="literal">NULL</span> &amp;&amp; security_buffers[i].BufferType == SECBUFFER_EXTRA) &#123;</span><br><span class="line">            pExtraBuffer = &amp;security_buffers[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//----------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">//  Prepare output buffers.</span></span><br><span class="line"></span><br><span class="line">    OutBuffDesc.ulVersion = SECBUFFER_VERSION;</span><br><span class="line">    OutBuffDesc.cBuffers = <span class="number">1</span>;</span><br><span class="line">    OutBuffDesc.pBuffers = OutSecBuff;</span><br><span class="line"></span><br><span class="line">    OutSecBuff[<span class="number">0</span>].cbBuffer = <span class="number">0</span>;</span><br><span class="line">    OutSecBuff[<span class="number">0</span>].BufferType = SECBUFFER_TOKEN;</span><br><span class="line">    OutSecBuff[<span class="number">0</span>].pvBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//OutSecBuff[1].cbBuffer = 0;</span></span><br><span class="line">    <span class="comment">//OutSecBuff[1].BufferType = SECBUFFER_EMPTY;</span></span><br><span class="line">    <span class="comment">//OutSecBuff[1].pvBuffer = NULL;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------------------------------------------------------------</span></span><br><span class="line">    <span class="comment">//  Prepare input buffers.</span></span><br><span class="line"></span><br><span class="line">    InBuffDesc.ulVersion = SECBUFFER_VERSION;</span><br><span class="line">    InBuffDesc.cBuffers = <span class="number">2</span>;</span><br><span class="line">    InBuffDesc.pBuffers = InSecBuff;</span><br><span class="line"></span><br><span class="line">    InSecBuff[<span class="number">0</span>].cbBuffer = pExtraBuffer-&gt;cbBuffer;</span><br><span class="line">    InSecBuff[<span class="number">0</span>].BufferType = SECBUFFER_TOKEN;</span><br><span class="line">    InSecBuff[<span class="number">0</span>].pvBuffer = pExtraBuffer-&gt;pvBuffer;</span><br><span class="line">    InSecBuff[<span class="number">1</span>].cbBuffer = <span class="number">0</span>;</span><br><span class="line">    InSecBuff[<span class="number">1</span>].BufferType = SECBUFFER_EMPTY;</span><br><span class="line">    InSecBuff[<span class="number">1</span>].pvBuffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Token buffer received (%lu bytes):\n&quot;</span>, InSecBuff[<span class="number">0</span>].cbBuffer);</span><br><span class="line">    PrintHexDump(InSecBuff[<span class="number">0</span>].cbBuffer, (PBYTE)InSecBuff[<span class="number">0</span>].pvBuffer);</span><br><span class="line"></span><br><span class="line">    Status = AcceptSecurityContext( </span><br><span class="line">        &amp;hcred,</span><br><span class="line">        &amp;hctxt,</span><br><span class="line">        &amp;InBuffDesc,</span><br><span class="line">        dwSSPIFlags,</span><br><span class="line">        SECURITY_NATIVE_DREP,<span class="comment">// not used according doc</span></span><br><span class="line">        &amp;hctxt,</span><br><span class="line">        &amp;OutBuffDesc,</span><br><span class="line">        &amp;dwSSPIFlags,</span><br><span class="line">        &amp;Lifetime);</span><br><span class="line"><span class="comment">// 这里会出错, 不清楚原因.</span></span><br><span class="line">    <span class="keyword">if</span> (Status &amp; <span class="number">0x80000000</span>) &#123;</span><br><span class="line">        LogError(<span class="string">&quot;fail to say hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>这段代码应该是这么写的, 但是我自己跑的时候, 在第二次的<code>AcceptSecurityContext</code>会遇到解密错误, 暂时不清楚原因, 但是网络上又找不到相关的实现做一个参考, 所以列出来希望对人有帮助.</p>
<p>参考:</p>
<p><a target="_blank" rel="noopener" href="https://microsoft.public.platformsdk.security.narkive.com/4xhIBWZi/schannel-and-session-renegotiation">Schannel and Session Renegotiation </a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/secauthn/renegotiating-an-schannel-connection">Renegotiating an Schannel Connection</a></p>
<h2 id="cmake"><a href="#cmake" class="headerlink" title="cmake"></a>cmake</h2><p>获取某个git项目下的依赖git项目: <code>git submodule update --init --recursive</code></p>
<p><code>cmake -DXXXX=ON ./</code> 表示开启XXXX特性, 生成makefile. XXXX特性由CMakeLists.txt定义, 形式如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option(suppress_header_searches &quot;do not try to find headers - used when compiler check will fail&quot; OFF)</span><br></pre></td></tr></table></figure>

<p>表示接受参数<code>-Dsuppress_header_searches=ON</code>, 默认是<code>OFF</code>.</p>
<p>生成makefile后, 执行<code>cmake --build .</code>编译</p>
</div></article></div></main><footer><div class="paginator"><a href="/2023/02/22/bug-skills/" class="prev">PREV</a><a href="/2023/02/22/lldb-help/" class="next">NEXT</a></div><div id="container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><div id="gitalk-container"></div><script>const gitalk = new Gitalk({
    clientID: '28b1a73c3ed656a9a85d',     
    clientSecret: '59837bb4cbe7b2f12df366fdbcb37fa4ba084d44',     
    id: 'Wed Feb 22 2023 19:54:44 GMT+0800',    
    repo: 'blog-comment',     
    owner: '474172261',     
    admin: '474172261',     
})   
gitalk.render('gitalk-container')</script><div class="copyright"><p>© 2015 - 2025 <a href="http://474172261.github.io">VictorV</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>